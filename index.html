<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>EVALUACI√ìN ¬∑ MATERIA DIN√ÅMICA</title>
    <link rel="manifest" href="manifest.json">
	<!-- Para iOS: icono cuando se a√±ade a la pantalla de inicio -->
	<link rel="apple-touch-icon" href="icon-192x192.png">
	<!-- Color de la barra de estado en Android (ya est√° en manifest, pero refuerza) -->
	<meta name="theme-color" content="#0b4b6b">
    <!-- Bootstrap 5 + Iconos -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SheetJS y jsPDF+autoTable -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { background-color: #e9f0f5; font-family: 'Segoe UI', Roboto, sans-serif; padding: 10px; margin: 0; }
        .container-custom { max-width: 1400px; margin: 0 auto; background: white; border-radius: 28px; box-shadow: 0 25px 45px -12px rgba(2,48,71,0.2); padding: 24px 28px; }
        .screen { display: none; }
        .screen.active { display: block; }
        .section-card { background-color: #fafcff; border-radius: 20px; padding: 20px 22px; margin-bottom: 24px; border: 1px solid #e2eaf1; box-shadow: 0 4px 12px rgba(0,49,78,0.03); transition: 0.2s; }
        .section-card:hover { box-shadow: 0 8px 18px rgba(13,110,253,0.08); border-color: #cbdbe9; }
        .section-title { display: flex; align-items: center; gap: 10px; font-weight: 600; color: #0b4b6b; margin-bottom: 20px; border-bottom: 2px dashed #b8d1dc; padding-bottom: 10px; }
        .section-title i { font-size: 1.6rem; color: #0d6efd; }
        .section-title .help-icon { font-size: 1.2rem; color: #6c757d; cursor: help; margin-left: auto; }
        .criteria-group { border-radius: 16px; padding: 16px 20px; margin-bottom: 20px; background-color: #f8fbfe; border-left: 8px solid; box-shadow: 0 2px 6px rgba(0,0,0,0.02); }
        .group-title { font-weight: 700; font-size: 1.2rem; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .student-tag { background: linear-gradient(145deg, #f0f4fa, #e3eaf0); padding: 6px 18px; border-radius: 40px; font-size: 0.9rem; margin: 4px; display: inline-block; border: 1px solid #c0d3df; box-shadow: 0 2px 3px rgba(0,0,0,0.02); }
        .student-tag i { margin-left: 5px; }
        .badge-criteria { background-color: #0d4e6e; color: white; font-size: 0.8rem; margin-right: 6px; padding: 6px 12px; border-radius: 20px; font-weight: 500; }
        .import-label { background-color: #ecf3f7; padding: 8px 20px; border-radius: 30px; cursor: pointer; border: 1px solid #adc6d3; font-weight: 500; }
        .hidden { display: none; }
        .validation-warning { background-color: #fff3cd; border-left: 6px solid #ffc107; padding: 12px 20px; border-radius: 10px; margin-bottom: 20px; font-weight: 500; }
        .table-custom th { background-color: #e9f0f5; color: #064663; }
        .modal-header { background: linear-gradient(145deg, #0d6efd, #0b5ed7); color: white; }
        .penalty-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; margin-top: 5px; }
        .penalty-option { display: flex; align-items: center; gap: 6px; padding: 8px; background-color: white; border-radius: 6px; border: 2px solid #e0edff; cursor: pointer; transition: 0.2s; }
        .penalty-option:hover { border-color: #3498db; background-color: #f0f7ff; }
        .penalty-option.selected { border-color: #2980b9; background-color: #e3f2fd; }
        .grade-select { width: 100%; padding: 6px 10px; border: 2px solid #d1e3ff; border-radius: 8px; background-color: white; font-size: 0.9rem; }
        .unanswered-field { background-color: #f0f4fa; border: 2px solid #e2eaf1; border-radius: 8px; padding: 8px 10px; text-align: center; font-weight: 600; color: #0b4b6b; }
        @media (max-width: 768px) { .container-custom { padding: 16px; } .section-card { padding: 16px; } }
        .home-card { transition: transform 0.2s; cursor: pointer; border: 2px solid #dee2e6; border-radius: 20px; }
        .home-card:hover { transform: scale(1.02); border-color: #0d6efd; box-shadow: 0 10px 25px rgba(13,110,253,0.2); }
        .app-switcher .btn { border-radius: 30px; margin-left: 6px; }

        /* --- INTRO (OVERLAY) --- */
        #intro-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 30%, #2e7d32, #1b5e20, #0a3f0a, #0f2f0f);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-family: 'Segoe UI', Roboto, sans-serif;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            transition: opacity 1s ease;
            opacity: 1;
            pointer-events: all;
        }
        #intro-overlay.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        .intro-title {
            font-size: clamp(2rem, 8vw, 4.5rem);
            font-weight: 700;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.4);
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9, #a5d6a7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            max-width: 900px;
        }
        .intro-subtitle {
            font-size: clamp(1rem, 3vw, 1.8rem);
            font-weight: 300;
            color: #f1f8e9;
            text-shadow: 1px 1px 4px #1b5e20;
            position: absolute;
            bottom: 40px;
            right: 40px;
            font-style: italic;
        }
        .intro-subtitle::before {
            content: "‚ú¶";
            color: #a5d6a7;
            margin-right: 8px;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <!-- INTRO CON FADE -->
    <div id="intro-overlay">
        <div class="intro-title">SISTEMA DE EVALUACI√ìN<br>DE ACTIVIDADES COMPETENCIALES</div>
        <div class="intro-subtitle">by @angelmicelti</div>
    </div>

<div class="container-custom">
    <!-- ========== CABECERA CON IMPORTADOR DE MATERIA ========== -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 border-bottom pb-3">
        <h1 class="fw-bold" style="color: #0b4b6b;">
            <i class="bi bi-diagram-3 me-2" style="color: #0d6efd;"></i>
            EVALUACI√ìN CRITERIAL ¬∑ <span id="subjectNameDisplay">[sin materia]</span>
        </h1>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-info" id="btnImportSubject"><i class="bi bi-upload"></i> Importar materia</button>
            <input type="file" id="importSubjectFile" accept=".json" class="hidden">
            <div class="app-switcher btn-group" role="group">
                <button type="button" class="btn btn-outline-secondary" id="btnHome"><i class="fas fa-home"></i> Inicio</button>
                <button type="button" class="btn btn-outline-primary" id="btnAppExam"><i class="bi bi-pencil-square"></i> Por preguntas</button>
                <button type="button" class="btn btn-outline-success" id="btnAppTest"><i class="fas fa-calculator"></i> Tipo test</button>
                <button type="button" class="btn btn-outline-warning" id="btnAppGeneric"><i class="bi bi-check2-circle"></i> Tarea gen√©rica</button>
            </div>
        </div>
    </div>

    <!-- ========== PANTALLA DE INICIO (HOME) ========== -->
    <div id="homeScreen" class="screen active">
        <!-- ICONO Y TEXTO ALUSIVO A LA FINALIDAD DE LA APP -->
        <div class="text-center my-4">
            <i class="bi bi-trophy-fill" style="font-size: 4rem; color: #28a745;"></i>
            <h2 class="mt-2" style="color: #0b4b6b; font-weight: 600;">Sistema de Evaluaci√≥n Competencial</h2>
            <p class="lead text-muted">Selecciona el tipo de actividad que deseas evaluar</p>
        </div>

        <div class="row g-4 justify-content-center mt-2">
            <div class="col-md-4">
                <div class="card home-card p-4 text-center h-100 d-flex flex-column" id="cardExam">
                    <i class="bi bi-pencil-square" style="font-size: 3rem; color: #0d6efd;"></i>
                    <h3 class="mt-3 fw-bold">Examen preguntas-criterios</h3>
                    <p class="text-muted flex-grow-1">Asigna criterios a cada pregunta y califica individualmente.</p>
                    <button class="btn btn-primary mt-auto"><i class="bi bi-box-arrow-in-right"></i> Usar</button>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card home-card p-4 text-center h-100 d-flex flex-column" id="cardTest">
                    <i class="fas fa-calculator" style="font-size: 3rem; color: #198754;"></i>
                    <h3 class="mt-3 fw-bold">Examen tipo test</h3>
                    <p class="text-muted flex-grow-1">Aciertos, fallos, y no sabe/no contesta. <br>Con o sin penalizaci√≥n. <br>Misma nota para todos los criterios.</p>
                    <button class="btn btn-success mt-auto"><i class="bi bi-box-arrow-in-right"></i> Usar</button>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card home-card p-4 text-center h-100 d-flex flex-column" id="cardGeneric">
                    <i class="bi bi-check2-circle" style="font-size: 3rem; color: #fd7e14;"></i>
                    <h3 class="mt-3 fw-bold">Evaluaci√≥n de una <br> tarea gen√©rica</h3>
                    <p class="text-muted flex-grow-1">Califica directamente cada criterio de una tarea con una nota entre 0 y 10.</p>
                    <button class="btn btn-warning mt-auto"><i class="bi bi-box-arrow-in-right"></i> Usar</button>
                </div>
            </div>
        </div>
        <div class="alert alert-info mt-5 text-center">
            <i class="bi bi-info-circle"></i> Primero importa un archivo de materia (formato <i>MATx.json</i>, donde <i>MAT</i> son las siglas de la materia y <i>x</i> el curso) para cargar los criterios.
        </div>
    </div>

    <!-- ========== APLICACI√ìN 1: EXAMEN POR PREGUNTAS ========== -->
    <div id="appExamContainer" class="screen">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="fw-bold"><i class="bi bi-pencil-square" style="color:#0d6efd;"></i> Examen por preguntas ¬∑ <span class="subject-badge-exam"></span></h3>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary active" id="examNavConfig">‚öôÔ∏è Configuraci√≥n</button>
                <button type="button" class="btn btn-outline-primary" id="examNavGrade">üìù Calificaci√≥n</button>
                <button type="button" class="btn btn-outline-primary" id="examNavResults">üìä Resultados</button>
            </div>
        </div>
        <!-- Pantalla CONFIGURACI√ìN EXAMEN -->
        <div id="examScreenConfig" class="screen active">
            <div class="section-card">
                <div class="section-title">
                    <i class="bi bi-pencil-square"></i> Identificaci√≥n del examen
                    <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" title="Nombre y curso del examen. Se usar√°n en los informes."></i>
                </div>
                <div class="row g-3 align-items-end">
                    <div class="col-md-4"><label class="form-label fw-semibold">üìå Nombre del examen</label><input type="text" id="examNameInput" class="form-control" value="Examen sin t√≠tulo"></div>
                    <div class="col-md-3"><label class="form-label fw-semibold">üìö Curso</label><input type="text" id="examCourseInput" class="form-control" value="Tecnolog√≠a Ciclos" placeholder="Ej: 4¬∫ ESO, 2¬∫ Bach..."></div>
                    <div class="col-md-5 d-flex justify-content-end gap-2">
                        <button id="examExportConfigBtn" class="btn btn-outline-primary"><i class="bi bi-file-earmark-arrow-down"></i> Exportar JSON</button>
                        <button id="examImportConfigBtn" class="btn btn-outline-secondary"><i class="bi bi-file-earmark-arrow-up"></i> Importar JSON</button>
                        <input type="file" id="examImportConfigFile" accept=".json" class="hidden">
                        <button id="examSaveToLocalBtn" class="btn btn-outline-success"><i class="bi bi-save"></i> Guardar local</button>
                        <button id="examLoadFromLocalBtn" class="btn btn-outline-info"><i class="bi bi-folder-symlink"></i> Cargar local</button>
                        <button id="examResetAllBtn" class="btn btn-outline-danger"><i class="bi bi-eraser"></i> Reiniciar todo</button>
                    </div>
                </div>
            </div>
            <div class="section-card">
                <div class="section-title">
                    <i class="bi bi-question-circle"></i> Gesti√≥n de preguntas y criterios
                    <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" title="Define las preguntas, su puntuaci√≥n m√°xima y asigna los criterios de evaluaci√≥n a cada una."></i>
                </div>
                <div class="row g-3 align-items-end mb-4">
                    <div class="col-md-3"><label class="form-label fw-semibold">N√∫mero de preguntas</label><input type="number" id="examInputNumQuestions" class="form-control" min="1" value="3"></div>
                    <div class="col-md-3"><button id="examBtnSetQuestions" class="btn btn-primary">üìå Generar / Resetear preguntas</button></div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#examGlobalCriteriaModal"><i class="bi bi-check2-square"></i> Criterios de la materia</button>
                        <span id="examSelectedCriteriaBadges" class="ms-2"></span>
                    </div>
                </div>
                <div id="examOrphanedCriteriaWarning" class="validation-warning" style="display:none;"><span id="examOrphanedCriteriaMessage"></span></div>
                <div class="table-responsive mt-3">
                    <table class="table table-bordered align-middle table-custom" id="examQuestionsTable"><thead><tr><th>Pregunta</th><th>Cal. m√°xima</th><th>Criterios</th><th>Acciones</th></tr></thead><tbody id="examQuestionsTbody"></tbody></table>
                </div>
                <div class="d-flex justify-content-end mt-2"><button id="examAppendQuestionBtn" class="btn btn-success btn-sm"><i class="bi bi-plus-circle"></i> A√±adir pregunta</button></div>
            </div>
            <div class="section-card">
                <div class="section-title">
                    <i class="bi bi-people-fill"></i> Alumnado (orden alfab√©tico)
                    <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" title="Lista de alumnos. Puedes a√±adirlos uno a uno o importarlos desde Excel/JSON. Haz clic en el l√°piz para editar el nombre."></i>
                </div>
                <div class="d-flex flex-wrap gap-3 align-items-center">
                    <div class="d-flex"><input type="text" id="examStudentNameInput" class="form-control" placeholder="Apellidos, Nombre" style="width:260px;"><button id="examBtnAddStudent" class="btn btn-success ms-2"><i class="bi bi-plus-circle"></i> +</button></div>
                    <div><label for="examImportFile" class="import-label"><i class="bi bi-file-earmark-arrow-up"></i> Importar Excel/JSON</label><input type="file" id="examImportFile" accept=".xlsx,.xls,.json,.csv" class="hidden"></div>
                    <button id="examBtnClearStudents" class="btn btn-sm btn-outline-danger">Limpiar lista</button>
                </div>
                <div id="examStudentListContainer" class="mt-3 p-3 bg-white rounded-3 border"><span class="fw-bold">üìå Lista: </span><span id="examStudentCountBadge">0</span> alumnos<div id="examStudentTags" class="mt-2 d-flex flex-wrap"></div></div>
                <div id="examDuplicateMessage" class="small text-danger mt-2"></div>
            </div>
        </div>
        <!-- Pantalla CALIFICACI√ìN EXAMEN -->
        <div id="examScreenGrade" class="screen">
            <div class="section-card">
                <div class="section-title">
                    <i class="bi bi-pencil-square"></i> Calificaciones por pregunta
                    <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" title="Introduce la nota de cada alumno en cada pregunta (0-10). Se guardan autom√°ticamente al cambiar de campo."></i>
                </div>
                <div id="examGradeTableWrapper" class="table-responsive" style="max-height:500px; overflow-y:auto;"><table class="table table-bordered table-striped" id="examGradeTable"><thead class="sticky-top bg-white"></thead><tbody id="examGradeTbody"></tbody></table></div>
                <div class="mt-3 d-flex flex-wrap gap-2 justify-content-end">
                    <button id="examBtnSaveScores" class="btn btn-primary"><i class="bi bi-save"></i> Guardar calificaciones</button>
                    <button id="examExportScoresBtn" class="btn btn-outline-dark"><i class="bi bi-download"></i> Exportar calificaciones</button>
                    <button id="examImportScoresBtn" class="btn btn-outline-secondary"><i class="bi bi-upload"></i> Importar calificaciones</button>
                    <input type="file" id="examImportScoresFile" accept=".json" class="hidden">
                    <button id="examRecoverScoresBtn" class="btn btn-outline-info"><i class="bi bi-arrow-repeat"></i> Recuperar calificaciones</button>
                </div>
                <div class="alert alert-info mt-3 small" id="examGradeMessage"></div>
            </div>
        </div>
        <!-- Pantalla RESULTADOS EXAMEN -->
        <div id="examScreenResults" class="screen">
            <div class="section-card">
                <div class="section-title">
                    <i class="bi bi-bar-chart-line"></i> Resultados por alumno y criterio <span id="examResultsExamNameSpan" class="badge bg-info ms-3 fs-6"></span>
                    <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" title="Notas de criterios calculadas como (suma de notas obtenidas / suma de m√°ximos de las preguntas que eval√∫an el criterio) * 10. Calificaci√≥n = media de criterios."></i>
                </div>
                <!-- Checkbox para mostrar/ocultar columna Calificaci√≥n -->
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="examShowGlobalGrade" checked>
                    <label class="form-check-label" for="examShowGlobalGrade">Mostrar columna Calificaci√≥n</label>
                </div>
                <div id="examResultsTableWrapper" class="table-responsive"><table class="table table-bordered table-hover" id="examResultsTable"><thead class="table-secondary"></thead><tbody id="examResultsTbody"></tbody></table></div>
                <div class="d-flex flex-wrap gap-3 mt-4 justify-content-between align-items-center">
                    <span class="fw-bold"><i class="bi bi-download"></i> Exportar resultados:</span>
                    <div>
                        <button id="examExportJSON" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#examExportModal"><i class="bi bi-filetype-json"></i> JSON</button>
                        <button id="examExportExcel" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#examExportModal"><i class="bi bi-file-earmark-excel"></i> Excel</button>
                        <button id="examExportPDF" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#examExportModal"><i class="bi bi-file-pdf"></i> PDF</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== APLICACI√ìN 2: TIPO TEST ========== -->
    <div id="appTestContainer" class="screen">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="fw-bold"><i class="fas fa-calculator" style="color:#198754;"></i> Examen tipo test ¬∑ <span class="subject-badge-test"></span></h3>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-primary active" id="testNavConfig">‚öôÔ∏è Configuraci√≥n</button>
                <button type="button" class="btn btn-outline-primary" id="testNavGrade">üìù Calificaci√≥n</button>
                <button type="button" class="btn btn-outline-primary" id="testNavResults">üìä Resultados</button>
            </div>
        </div>
        <!-- Pantalla CONFIGURACI√ìN TEST -->
        <div id="testScreenConfig" class="screen active">
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-clipboard-list"></i> Datos generales
                    <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" title="T√≠tulo del test y curso."></i>
                </div>
                <div class="row g-4">
                    <div class="col-md-6"><label class="form-label fw-semibold">üìå Nombre del examen</label><input type="text" id="testExamTitleInput" class="form-control" value="Examen tipo test"></div>
                    <div class="col-md-6"><label class="form-label fw-semibold">üìö Curso</label><input type="text" id="testCourseInput" class="form-control" value="Tecnolog√≠a Ciclos" placeholder="Ej: 4¬∫ ESO, 2¬∫ Bach..."></div>
                </div>
                <div class="d-flex justify-content-end mt-2">
                    <button id="testResetAllBtn" class="btn btn-outline-danger"><i class="bi bi-eraser"></i> Reiniciar todo</button>
                </div>
            </div>
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-question-circle"></i> Configuraci√≥n del test
                    <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" title="N√∫mero total de preguntas y factor de penalizaci√≥n por respuesta incorrecta."></i>
                </div>
                <div class="row g-4">
                    <div class="col-md-6"><label class="form-label fw-semibold">N¬∫ total preguntas:</label><input type="number" id="testTotalQuestions" class="form-control" min="1" value="20"></div>
                    <div class="col-md-6"><label class="form-label fw-semibold">Penalizaci√≥n:</label>
                        <div class="penalty-options" id="testPenaltyOptions">
                            <div class="penalty-option" data-value="0"><input type="radio" name="penalty" id="testPenalty0" value="0" checked><label for="testPenalty0">Sin penalizaci√≥n</label></div>
                            <div class="penalty-option" data-value="0.2"><input type="radio" name="penalty" id="testPenalty5" value="0.2"><label for="testPenalty5">1/5</label></div>
                            <div class="penalty-option" data-value="0.25"><input type="radio" name="penalty" id="testPenalty4" value="0.25"><label for="testPenalty4">1/4</label></div>
                            <div class="penalty-option" data-value="0.333"><input type="radio" name="penalty" id="testPenalty3" value="0.333"><label for="testPenalty3">1/3</label></div>
                            <div class="penalty-option" data-value="0.5"><input type="radio" name="penalty" id="testPenalty2" value="0.5"><label for="testPenalty2">1/2</label></div>
                            <div class="penalty-option" data-value="1"><input type="radio" name="penalty" id="testPenalty1" value="1"><label for="testPenalty1">Igual</label></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-check-double"></i> Criterios de la materia
                    <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" title="Selecciona los criterios que evaluar√° este test. Todos los alumnos recibir√°n la misma nota en cada criterio (la nota del test)."></i>
                </div>
                <div class="d-flex flex-wrap align-items-center gap-3">
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#testGlobalCriteriaModal"><i class="fas fa-tags"></i> Seleccionar criterios</button>
                    <span id="testSelectedCriteriaBadges" class="d-flex flex-wrap gap-1"></span>
                </div>
                <div id="testNoCriteriaWarning" class="text-danger small mt-2 fw-bold" style="display:none;"><i class="fas fa-exclamation-triangle"></i> Debes seleccionar al menos un criterio.</div>
            </div>
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-users"></i> Alumnado
                    <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" title="Lista de alumnos que realizar√°n el test. Haz clic en el l√°piz para editar el nombre."></i>
                </div>
                <div class="d-flex flex-wrap gap-3 align-items-center">
                    <div class="d-flex"><input type="text" id="testStudentNameInput" class="form-control" placeholder="Apellidos, Nombre" style="width:260px;"><button id="testBtnAddStudent" class="btn btn-success ms-2"><i class="fas fa-plus-circle"></i> +</button></div>
                    <div><label for="testImportFile" class="import-label"><i class="fas fa-file-import"></i> Importar</label><input type="file" id="testImportFile" accept=".xlsx,.xls,.json,.csv" class="hidden"></div>
                    <button id="testBtnClearStudents" class="btn btn-sm btn-outline-danger">Limpiar</button>
                </div>
                <div id="testStudentListContainer" class="mt-3 p-3 bg-white rounded-3 border"><span class="fw-bold">üìå Lista: </span><span id="testStudentCountBadge">0</span> alumnos<div id="testStudentTags" class="mt-2 d-flex flex-wrap"></div></div>
                <div id="testDuplicateMessage" class="small text-danger mt-2"></div>
            </div>
            <div class="d-flex flex-wrap justify-content-end gap-2 mt-2">
                <button id="testExportConfigBtn" class="btn btn-outline-primary btn-sm"><i class="fas fa-download"></i> Exportar JSON</button>
                <button id="testImportConfigBtn" class="btn btn-outline-secondary btn-sm"><i class="fas fa-upload"></i> Importar JSON</button>
                <input type="file" id="testImportConfigFile" accept=".json" class="hidden">
                <button id="testSaveToLocalBtn" class="btn btn-outline-success btn-sm"><i class="fas fa-save"></i> Guardar local</button>
                <button id="testLoadFromLocalBtn" class="btn btn-outline-info btn-sm"><i class="fas fa-folder-open"></i> Cargar local</button>
            </div>
        </div>
        <!-- Pantalla CALIFICACI√ìN TEST -->
        <div id="testScreenGrade" class="screen">
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-pencil-alt"></i> Calificaciones por alumno
                    <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" title="Para cada alumno, selecciona el n√∫mero de aciertos y fallos. El campo NS/NC se calcula autom√°ticamente."></i>
                </div>
                <div id="testGradeTableWrapper" class="table-responsive" style="max-height:600px;"><table class="table table-bordered table-striped" id="testGradeTable"><thead class="table-secondary sticky-top"></thead><tbody id="testGradeTbody"></tbody></table></div>
                <div class="mt-3 d-flex justify-content-end"><button id="testBtnSaveScores" class="btn btn-primary"><i class="fas fa-save"></i> Guardar</button></div>
                <div class="alert alert-info mt-3 small" id="testGradeMessage"></div>
            </div>
        </div>
        <!-- Pantalla RESULTADOS TEST -->
        <div id="testScreenResults" class="screen">
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-chart-line"></i> Resultados por alumno y criterio <span id="testResultsExamNameSpan" class="badge bg-info ms-3 fs-6"></span>
                    <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" title="Cada criterio recibe la misma nota (la nota del test calculada con aciertos y penalizaci√≥n)."></i>
                </div>
                <!-- Checkbox para mostrar/ocultar columna Calificaci√≥n -->
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="testShowGlobalGrade" checked>
                    <label class="form-check-label" for="testShowGlobalGrade">Mostrar columna Calificaci√≥n</label>
                </div>
                <div id="testResultsTableWrapper" class="table-responsive"><table class="table table-bordered table-hover" id="testResultsTable"><thead class="table-secondary"></thead><tbody id="testResultsTbody"></tbody></table></div>
                <div class="d-flex flex-wrap gap-3 mt-4 justify-content-between align-items-center">
                    <span class="fw-bold"><i class="fas fa-download"></i> Exportar:</span>
                    <div>
                        <button id="testExportJSON" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#testExportModal"><i class="bi bi-filetype-json"></i> JSON</button>
                        <button id="testExportExcel" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#testExportModal"><i class="bi bi-file-earmark-excel"></i> Excel</button>
                        <button id="testExportPDF" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#testExportModal"><i class="bi bi-file-pdf"></i> PDF</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== APLICACI√ìN 3: EVALUACI√ìN GEN√âRICA ========== -->
    <div id="appGenericContainer" class="screen">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="fw-bold"><i class="bi bi-check2-circle" style="color:#fd7e14;"></i> Evaluaci√≥n de tarea por criterios ¬∑ <span class="subject-badge-generic"></span></h3>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-primary active" id="genericNavConfig">‚öôÔ∏è Configuraci√≥n</button>
                <button type="button" class="btn btn-outline-primary" id="genericNavGrade">üìù Calificaci√≥n</button>
                <button type="button" class="btn btn-outline-primary" id="genericNavResults">üìä Resultados</button>
            </div>
        </div>
        <!-- Pantalla CONFIGURACI√ìN GEN√âRICA -->
        <div id="genericScreenConfig" class="screen active">
            <div class="section-card">
                <div class="section-title">
                    <i class="bi bi-pencil-square"></i> Configuraci√≥n de la actividad
                    <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" title="Nombre de la actividad y curso."></i>
                </div>
                <div class="row g-3 align-items-end">
                    <div class="col-md-4"><label class="form-label fw-semibold">üìå Nombre de la actividad</label><input type="text" id="genericExamNameInput" class="form-control" value="Actividad sin t√≠tulo"></div>
                    <div class="col-md-3"><label class="form-label fw-semibold">üìö Curso</label><input type="text" id="genericCourseInput" class="form-control" value="Tecnolog√≠a Ciclos" placeholder="Ej: 4¬∫ ESO, 2¬∫ Bach..."></div>
                    <div class="col-md-5 d-flex justify-content-end gap-2">
                        <button id="genericExportConfigBtn" class="btn btn-outline-primary"><i class="bi bi-file-earmark-arrow-down"></i> Exportar JSON</button>
                        <button id="genericImportConfigBtn" class="btn btn-outline-secondary"><i class="bi bi-file-earmark-arrow-up"></i> Importar JSON</button>
                        <input type="file" id="genericImportConfigFile" accept=".json" class="hidden">
                        <button id="genericSaveToLocalBtn" class="btn btn-outline-success"><i class="bi bi-save"></i> Guardar local</button>
                        <button id="genericLoadFromLocalBtn" class="btn btn-outline-info"><i class="bi bi-folder-symlink"></i> Cargar local</button>
                        <button id="genericResetAllBtn" class="btn btn-outline-danger"><i class="bi bi-eraser"></i> Reiniciar todo</button>
                    </div>
                </div>
            </div>
            <div class="section-card">
                <div class="section-title">
                    <i class="bi bi-check2-square"></i> Gesti√≥n de criterios
                    <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" title="Selecciona los criterios que se evaluar√°n en esta actividad."></i>
                </div>
                <div class="d-flex align-items-center gap-3 flex-wrap">
                    <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#genericGlobalCriteriaModal"><i class="bi bi-check2-square"></i> Seleccionar criterios de la materia</button>
                    <span id="genericSelectedCriteriaBadges" class="d-flex flex-wrap gap-1"></span>
                </div>
                <div id="genericOrphanedCriteriaWarning" class="validation-warning mt-3" style="display:none;"><span id="genericOrphanedCriteriaMessage"></span></div>
            </div>
            <div class="section-card">
                <div class="section-title">
                    <i class="bi bi-people-fill"></i> Alumnado (orden alfab√©tico)
                    <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" title="Lista de alumnos que ser√°n evaluados. Haz clic en el l√°piz para editar el nombre."></i>
                </div>
                <div class="d-flex flex-wrap gap-3 align-items-center">
                    <div class="d-flex"><input type="text" id="genericStudentNameInput" class="form-control" placeholder="Apellidos, Nombre" style="width:260px;"><button id="genericBtnAddStudent" class="btn btn-success ms-2"><i class="bi bi-plus-circle"></i> +</button></div>
                    <div><label for="genericImportFile" class="import-label"><i class="bi bi-file-earmark-arrow-up"></i> Importar</label><input type="file" id="genericImportFile" accept=".xlsx,.xls,.json,.csv" class="hidden"></div>
                    <button id="genericBtnClearStudents" class="btn btn-sm btn-outline-danger">Limpiar</button>
                </div>
                <div id="genericStudentListContainer" class="mt-3 p-3 bg-white rounded-3 border"><span class="fw-bold">üìå Lista: </span><span id="genericStudentCountBadge">0</span> alumnos<div id="genericStudentTags" class="mt-2 d-flex flex-wrap"></div></div>
                <div id="genericDuplicateMessage" class="small text-danger mt-2"></div>
            </div>
        </div>
        <!-- Pantalla CALIFICACI√ìN GEN√âRICA -->
        <div id="genericScreenGrade" class="screen">
            <div class="section-card">
                <div class="section-title">
                    <i class="bi bi-pencil-square"></i> Calificaciones por criterio
                    <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" title="Introduce una nota (0-10) para cada alumno en cada criterio."></i>
                </div>
                <div id="genericGradeTableWrapper" class="table-responsive" style="max-height:500px;"><table class="table table-bordered table-striped" id="genericGradeTable"><thead class="sticky-top bg-white"></thead><tbody id="genericGradeTbody"></tbody></table></div>
                <div class="mt-3 d-flex justify-content-end"><button id="genericBtnSaveScores" class="btn btn-primary"><i class="bi bi-save"></i> Guardar</button></div>
                <div class="alert alert-info mt-3 small" id="genericGradeMessage"></div>
            </div>
        </div>
        <!-- Pantalla RESULTADOS GEN√âRICA -->
        <div id="genericScreenResults" class="screen">
            <div class="section-card">
                <div class="section-title">
                    <i class="bi bi-bar-chart-line"></i> Resultados por alumno y criterio <span id="genericResultsExamNameSpan" class="badge bg-info ms-3 fs-6"></span>
                    <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" title="Notas directas introducidas en la pantalla de calificaci√≥n."></i>
                </div>
                <!-- Checkbox para mostrar/ocultar columna Calificaci√≥n -->
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="genericShowGlobalGrade" checked>
                    <label class="form-check-label" for="genericShowGlobalGrade">Mostrar columna Calificaci√≥n</label>
                </div>
                <div id="genericResultsTableWrapper" class="table-responsive"><table class="table table-bordered table-hover" id="genericResultsTable"><thead class="table-secondary"></thead><tbody id="genericResultsTbody"></tbody></table></div>
                <div class="d-flex flex-wrap gap-3 mt-4 justify-content-between align-items-center">
                    <span class="fw-bold"><i class="bi bi-download"></i> Exportar resultados:</span>
                    <div>
                        <button id="genericExportJSON" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#genericExportModal"><i class="bi bi-filetype-json"></i> JSON</button>
                        <button id="genericExportExcel" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#genericExportModal"><i class="bi bi-file-earmark-excel"></i> Excel</button>
                        <button id="genericExportPDF" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#genericExportModal"><i class="bi bi-file-pdf"></i> PDF</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== MODALES DE CRITERIOS GLOBALES ========== -->
    <div class="modal fade" id="examGlobalCriteriaModal" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Criterios de la materia - Examen por preguntas</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" id="examGlobalCriteriaGroupedContainer"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-primary" id="examSaveGlobalCriteria" data-bs-dismiss="modal">Guardar</button></div></div></div></div>
    <div class="modal fade" id="testGlobalCriteriaModal" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Criterios de la materia - Tipo test</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" id="testGlobalCriteriaGroupedContainer"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-primary" id="testSaveGlobalCriteria" data-bs-dismiss="modal">Guardar</button></div></div></div></div>
    <div class="modal fade" id="genericGlobalCriteriaModal" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Criterios de la materia - Evaluaci√≥n gen√©rica</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" id="genericGlobalCriteriaGroupedContainer"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-primary" id="genericSaveGlobalCriteria" data-bs-dismiss="modal">Guardar</button></div></div></div></div>
    <!-- Modal asignar criterios a pregunta (solo examen) -->
    <div class="modal fade" id="examQuestionCriteriaModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header bg-secondary text-white"><h5 class="modal-title">Asignar criterios - Pregunta <span id="examModalQuestionId"></span></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="examQuestionCriteriaGroupedContainer"></div><div class="modal-footer"><button type="button" class="btn btn-primary" id="examSaveQuestionCriteria" data-bs-dismiss="modal">Guardar</button></div></div></div></div>

    <!-- ========== MODALES PARA EXPORTACI√ìN CON OPCI√ìN DE COLUMNA CALIFICACI√ìN ========== -->
    <!-- Modal para examen -->
    <div class="modal fade" id="examExportModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Exportar resultados</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="examExportIncludeGrade" checked>
                        <label class="form-check-label" for="examExportIncludeGrade">Incluir columna Calificaci√≥n</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="examExportConfirm">Exportar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal para test -->
    <div class="modal fade" id="testExportModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Exportar resultados</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="testExportIncludeGrade" checked>
                        <label class="form-check-label" for="testExportIncludeGrade">Incluir columna Calificaci√≥n</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="testExportConfirm">Exportar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal para gen√©rica -->
    <div class="modal fade" id="genericExportModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Exportar resultados</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="genericExportIncludeGrade" checked>
                        <label class="form-check-label" for="genericExportIncludeGrade">Incluir columna Calificaci√≥n</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="genericExportConfirm">Exportar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // =========================================================================
    //   VARIABLES GLOBALES: materia importada
    // =========================================================================
    let subjectInfo = {
        name: '',
        course: '',
        criteriaCodes: [],      // c√≥digos sin punto final (ej. "MAA.4.1.1")
        criteriaDescriptions: {} // mapa c√≥digo -> descripci√≥n
    };

    // Colores para las competencias (se asignar√°n c√≠clicamente)
    const competenceColors = ['#0d6efd', '#198754', '#fd7e14', '#6f42c1', '#d63384', '#20c997', '#0dcaf0', '#ffc107', '#dc3545', '#6610f2'];

    // =========================================================================
    //   FUNCIONES PARA PROCESAR EL JSON DE MATERIA
    // =========================================================================
    function loadSubjectFromJSON(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if (!data.materia || !data.curso || !Array.isArray(data.competencias)) {
                    throw new Error('El JSON no tiene el formato esperado (materia, curso, competencias)');
                }
                subjectInfo.name = data.materia;
                subjectInfo.course = data.curso;

                // Extraer todos los c√≥digos y descripciones, quitando el punto final si existe
                const codes = [];
                const descMap = {};
                data.competencias.forEach(comp => {
                    if (Array.isArray(comp.criterios)) {
                        comp.criterios.forEach(crit => {
                            let code = crit.codigo;
                            // Eliminar punto final para almacenar internamente sin punto
                            if (code.endsWith('.')) code = code.slice(0, -1);
                            codes.push(code);
                            descMap[code] = crit.texto || '';
                        });
                    }
                });
                subjectInfo.criteriaCodes = codes;
                subjectInfo.criteriaDescriptions = descMap;

                // Actualizar t√≠tulo
                document.getElementById('subjectNameDisplay').textContent = `${subjectInfo.name} ${subjectInfo.course}`;

                // Reiniciar criterios seleccionados en cada aplicaci√≥n (los arrays globalCriteria se vac√≠an)
                examState.globalCriteria = [];
                testState.globalCriteria = [];
                genericState.globalCriteria = [];

                // Reiniciar puntuaciones asociadas (los scores ahora no corresponden)
                examState.scores = examState.students.map(() => new Array(examState.questions.length).fill(0));
                testState.studentScores = testState.students.map(() => ({correct:0, wrong:0, unanswered:testState.totalQuestions}));
                genericState.scores = genericState.students.map(() => []);

                // Repoblar todos los modales con los nuevos criterios
                populateAllCriteriaModals();

                // Actualizar badges y mensajes
                renderExamGlobalBadges();
                renderTestGlobalBadges();
                renderGenericGlobalBadges();

                // Actualizar los span de materia en los t√≠tulos
                document.querySelectorAll('.subject-badge-exam, .subject-badge-test, .subject-badge-generic').forEach(el => el.textContent = subjectInfo.name);

                alert(`Materia "${subjectInfo.name}${subjectInfo.course}" cargada con ${subjectInfo.criteriaCodes.length} criterios.`);
            } catch (err) {
                alert('Error al procesar el archivo: ' + err.message);
            }
        };
        reader.readAsText(file);
    }

    // =========================================================================
    //   FUNCI√ìN PARA OBTENER DESCRIPCI√ìN DE UN CRITERIO
    // =========================================================================
    function getCriteriaDescription(code) {
        return subjectInfo.criteriaDescriptions[code] || 'Descripci√≥n no disponible';
    }

    // =========================================================================
    //   AGRUPACI√ìN DIN√ÅMICA POR COMPETENCIA (extrae base hasta el tercer punto)
    // =========================================================================
    function groupCriteriaByCompetence(criteriaArray) {
        const groups = {};
        criteriaArray.forEach(code => {
            const match = code.match(/^([^.]+\.\d+\.\d+)/);
            if (match) {
                const groupKey = match[1];
                if (!groups[groupKey]) groups[groupKey] = [];
                groups[groupKey].push(code);
            } else {
                if (!groups['Otros']) groups['Otros'] = [];
                groups['Otros'].push(code);
            }
        });
        return groups;
    }

    // =========================================================================
    //   REFRESCAR TODOS LOS MODALES DE CRITERIOS
    // =========================================================================
    function populateAllCriteriaModals() {
        populateCriteriaModal('examGlobalCriteriaGroupedContainer', subjectInfo.criteriaCodes, 'exam');
        populateCriteriaModal('testGlobalCriteriaGroupedContainer', subjectInfo.criteriaCodes, 'test');
        populateCriteriaModal('genericGlobalCriteriaGroupedContainer', subjectInfo.criteriaCodes, 'generic');
    }

    function populateCriteriaModal(containerId, codes, appPrefix) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = '';
        if (codes.length === 0) {
            container.innerHTML = '<div class="alert alert-warning">No hay criterios. Importa una materia primero.</div>';
            return;
        }
        const groups = groupCriteriaByCompetence(codes);
        const sortedGroups = Object.keys(groups).sort((a,b) => a.localeCompare(b, undefined, {numeric: true}));
        sortedGroups.forEach((groupKey, index) => {
            const groupCodes = groups[groupKey];
            const groupDiv = document.createElement('div');
            groupDiv.className = 'criteria-group';
            groupDiv.style.borderLeftColor = competenceColors[index % competenceColors.length];
            groupDiv.innerHTML = `<div class="group-title"><i class="bi bi-diagram-3"></i> ${groupKey}</div><div class="row"></div>`;
            const rowDiv = groupDiv.querySelector('.row');
            groupCodes.forEach(code => {
                const col = document.createElement('div'); col.className = 'col-md-4 mb-2';
                const inputId = `${appPrefix}_chk_${code.replace(/\./g,'_')}`;
                const desc = getCriteriaDescription(code);
                col.innerHTML = `<div class="form-check"><input class="form-check-input global-criteria-chk" type="checkbox" value="${code}" id="${inputId}"><label class="form-check-label" for="${inputId}" title="${desc.replace(/"/g, '&quot;')}">${code}</label></div>`;
                rowDiv.appendChild(col);
            });
            container.appendChild(groupDiv);
        });

        // Marcar las que est√°n seleccionadas en el estado correspondiente
        let selected = [];
        if (appPrefix === 'exam') selected = examState.globalCriteria;
        else if (appPrefix === 'test') selected = testState.globalCriteria;
        else if (appPrefix === 'generic') selected = genericState.globalCriteria;

        container.querySelectorAll('.global-criteria-chk').forEach(chk => {
            chk.checked = selected.includes(chk.value);
        });
    }

    // =========================================================================
    //   FUNCIONES COMUNES (copiadas del original y adaptadas)
    // =========================================================================
    function uuid() { return Date.now()+'-'+Math.random(); }
    function sanitizeFilename(str) { return str.replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë√º√ú\-]/g,''); }
    function capitalizeFirst(str) { if (!str) return ''; return str.charAt(0).toUpperCase() + str.slice(1); }
    function capitalizeBasename(name) { return name.split('_').map(capitalizeFirst).join('_'); }

    // =========================================================================
    //   FUNCIONES COMUNES PARA GESTI√ìN DE ALUMNOS (PARAMETRIZADAS)
    // =========================================================================
    function sortStudents(state, scoresField = 'scores') {
        const indices = state.students.map((_,i)=>i).sort((a,b)=> state.students[a].fullName.localeCompare(state.students[b].fullName,'es',{sensitivity:'base'}));
        state.students = indices.map(i=>state.students[i]);
        if (scoresField === 'scores' && state.scores) state.scores = indices.map(i=>state.scores[i] || []);
        else if (scoresField === 'studentScores' && state.studentScores) state.studentScores = indices.map(i=>state.studentScores[i]);
    }
    function isStudentDuplicate(state, name) {
        return state.students.some(s => s.fullName.trim().toLowerCase() === name.trim().toLowerCase());
    }
    // NUEVA VERSI√ìN: incluye edici√≥n y eliminaci√≥n, y acepta un callback de cambio
    function renderStudentTags(state, containerId, countId, changeCallback) {
        const tagsDiv = document.getElementById(containerId);
        const countSpan = document.getElementById(countId);
        if (!tagsDiv) return;
        tagsDiv.innerHTML = '';
        countSpan.textContent = state.students.length;
        state.students.forEach((student, idx) => {
            const span = document.createElement('span');
            span.className = 'student-tag';
            span.innerHTML = `${student.fullName} 
                <i class="bi bi-pencil-fill text-primary" style="cursor:pointer; margin-left:5px;" data-stuidx="${idx}" data-action="edit"></i>
                <i class="bi bi-x-circle-fill text-danger" style="cursor:pointer;" data-stuidx="${idx}" data-action="delete"></i>`;
            tagsDiv.appendChild(span);
        });

        // Evento para eliminar
        tagsDiv.querySelectorAll('i[data-action="delete"]').forEach(icon => {
            icon.addEventListener('click', function(e) {
                e.stopPropagation();
                const idx = parseInt(this.dataset.stuidx);
                state.students.splice(idx, 1);
                if (state.scores) state.scores.splice(idx, 1);
                if (state.studentScores) state.studentScores.splice(idx, 1);
                if (changeCallback) changeCallback();
            });
        });

        // Evento para editar
        tagsDiv.querySelectorAll('i[data-action="edit"]').forEach(icon => {
            icon.addEventListener('click', function(e) {
                e.stopPropagation();
                const idx = parseInt(this.dataset.stuidx);
                const oldName = state.students[idx].fullName;
                const newName = prompt('Editar nombre del alumno:', oldName);
                if (newName && newName.trim() !== '' && newName.trim() !== oldName) {
                    state.students[idx].fullName = newName.trim();
                    if (changeCallback) changeCallback();
                }
            });
        });
    }
    function showDuplicateMessage(containerId, text) {
        const msg = document.getElementById(containerId);
        if (msg) msg.innerHTML = text ? `<i class="bi bi-exclamation-triangle-fill"></i> ${text}` : '';
    }

    // =========================================================================
    //   FUNCIONES COMUNES PARA IMPORTAR ALUMNOS DESDE EXCEL/JSON
    // =========================================================================
    function importStudentsFromFile(file, state, scoresField, afterImportCallback) {
        const ext = file.name.split('.').pop().toLowerCase();
        const reader = new FileReader();
        reader.onload = function(e) {
            let importedNames = [];
            if (ext === 'json') {
                try { importedNames = JSON.parse(e.target.result); } catch { alert('JSON inv√°lido'); return; }
                if (!Array.isArray(importedNames)) importedNames = Object.values(importedNames);
            } else if (['xlsx','xls'].includes(ext)) {
                try {
                    const wb = XLSX.read(e.target.result, { type: 'binary' });
                    const sheet = wb.Sheets[wb.SheetNames[0]];
                    const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    importedNames = data.slice(1).map(row => row[0]).filter(v => v && typeof v === 'string');
                } catch { alert('Error al leer Excel'); return; }
            } else { alert('Formato no soportado'); return; }
            let added = 0, skipped = 0;
            importedNames.forEach(name => {
                if (name && name.trim()) {
                    const trimmed = name.trim();
                    if (!isStudentDuplicate(state, trimmed)) {
                        state.students.push({ id: uuid(), fullName: trimmed });
                        if (scoresField === 'scores' && state.scores) state.scores.push(new Array(state.globalCriteria?.length || state.questions?.length || 0).fill(0));
                        else if (scoresField === 'studentScores' && state.studentScores) {
                            if (state.totalQuestions) state.studentScores.push({ correct:0, wrong:0, unanswered:state.totalQuestions });
                            else state.studentScores.push({});
                        }
                        added++;
                    } else skipped++;
                }
            });
            if (added > 0) {
                sortStudents(state, scoresField);
                if (afterImportCallback) afterImportCallback();
            }
            showDuplicateMessage(state.duplicateMessageId, skipped>0 ? `Se omitieron ${skipped} duplicado(s).` : '');
        };
        if (ext === 'xlsx' || ext === 'xls') reader.readAsBinaryString(file);
        else reader.readAsText(file);
    }

    // =========================================================================
    //   ESTADOS GLOBALES DE CADA APLICACI√ìN (INDEPENDIENTES)
    // =========================================================================
    const examState = {
        examName: "Examen sin t√≠tulo", course: "Tecnolog√≠a Ciclos",
        students: [], questions: [{id:1, maxScore:10, criteriaCodes:[]}],
        globalCriteria: [], scores: [],
        duplicateMessageId: 'examDuplicateMessage'
    };
    const testState = {
        examName: "Examen tipo test", course: "Tecnolog√≠a Ciclos",
        totalQuestions: 20, penaltyFactor: 0,
        globalCriteria: [], students: [], studentScores: [],
        duplicateMessageId: 'testDuplicateMessage'
    };
    const genericState = {
        examName: "Actividad sin t√≠tulo", course: "Tecnolog√≠a Ciclos",
        students: [], globalCriteria: [], scores: [],
        duplicateMessageId: 'genericDuplicateMessage'
    };

    // =========================================================================
    //   FUNCIONES DE NORMALIZACI√ìN Y CLAMP
    // =========================================================================
    function clampExamScores() {
        // Asegura que cada nota est√© entre 0 y el maxScore de su pregunta
        examState.scores.forEach((studentScores, sIdx) => {
            if (!studentScores) return;
            studentScores.forEach((score, qIdx) => {
                const max = examState.questions[qIdx]?.maxScore || 10;
                if (score > max) studentScores[qIdx] = max;
                else if (score < 0) studentScores[qIdx] = 0;
            });
        });
    }

    function normalizeExamScores() {
        const nQ = examState.questions.length;
        examState.scores = examState.scores.map(row => { 
            if (!row) return new Array(nQ).fill(0); 
            if (row.length < nQ) return [...row, ...new Array(nQ - row.length).fill(0)]; 
            if (row.length > nQ) return row.slice(0, nQ); 
            return row; 
        });
        while (examState.scores.length < examState.students.length) examState.scores.push(new Array(nQ).fill(0));
        if (examState.scores.length > examState.students.length) examState.scores = examState.scores.slice(0, examState.students.length);
        clampExamScores(); // Aplicar l√≠mites
    }

    function normalizeGenericScores() {
        const nC = genericState.globalCriteria.length;
        genericState.scores = genericState.scores.map(row => { 
            if (!row) return new Array(nC).fill(0); 
            if (row.length < nC) return [...row, ...new Array(nC - row.length).fill(0)]; 
            if (row.length > nC) return row.slice(0, nC); 
            return row; 
        });
        while (genericState.scores.length < genericState.students.length) genericState.scores.push(new Array(nC).fill(0));
        if (genericState.scores.length > genericState.students.length) genericState.scores = genericState.scores.slice(0, genericState.students.length);
        // Clamp cada nota entre 0 y 10
        genericState.scores.forEach(studentScores => {
            if (!studentScores) return;
            studentScores.forEach((score, idx) => {
                if (score > 10) studentScores[idx] = 10;
                else if (score < 0) studentScores[idx] = 0;
            });
        });
    }

    // =========================================================================
    //   FUNCIONES DE RENDERIZADO DE BADGES (con tooltips y data-code)
    //   Se a√±ade un punto al final del c√≥digo para mostrarlo correctamente.
    // =========================================================================
    function renderExamGlobalBadges() {
        const container = document.getElementById('examSelectedCriteriaBadges');
        if (!container) return;
        container.innerHTML = '';
        examState.globalCriteria.forEach(code => {
            let span = document.createElement('span');
            span.className = 'badge bg-primary me-1 p-2 criteria-badge';
            span.textContent = code + '.';  // A√ëADIDO PUNTO
            span.setAttribute('data-code', code);
            span.setAttribute('title', getCriteriaDescription(code));
            container.appendChild(span);
        });
        if (examState.globalCriteria.length===0) container.innerHTML = '<span class="badge bg-secondary">Ning√∫n criterio seleccionado</span>';
        validateExamCriteria();
    }
    function renderTestGlobalBadges() {
        const container = document.getElementById('testSelectedCriteriaBadges');
        if (!container) return;
        container.innerHTML = '';
        testState.globalCriteria.forEach(code => {
            let span = document.createElement('span');
            span.className = 'badge bg-primary me-1 p-2 criteria-badge';
            span.textContent = code + '.';  // A√ëADIDO PUNTO
            span.setAttribute('data-code', code);
            span.setAttribute('title', getCriteriaDescription(code));
            container.appendChild(span);
        });
        if (testState.globalCriteria.length===0) container.innerHTML = '<span class="badge bg-secondary">Ning√∫n criterio seleccionado</span>';
        const warn = document.getElementById('testNoCriteriaWarning'); if (warn) warn.style.display = testState.globalCriteria.length===0 ? 'block' : 'none';
    }
    function renderGenericGlobalBadges() {
        const container = document.getElementById('genericSelectedCriteriaBadges');
        if (!container) return;
        container.innerHTML = '';
        genericState.globalCriteria.forEach(code => {
            let span = document.createElement('span');
            span.className = 'badge bg-primary me-1 p-2 criteria-badge';
            span.textContent = code + '.';  // A√ëADIDO PUNTO
            span.setAttribute('data-code', code);
            span.setAttribute('title', getCriteriaDescription(code));
            container.appendChild(span);
        });
        if (genericState.globalCriteria.length===0) container.innerHTML = '<span class="badge bg-secondary">Ning√∫n criterio seleccionado</span>';
        validateGenericCriteria();
    }

    // =========================================================================
    //   VALIDACIONES
    // =========================================================================
    function validateExamCriteria() {
        const warning = document.getElementById('examOrphanedCriteriaWarning');
        const msg = document.getElementById('examOrphanedCriteriaMessage');
        if (examState.globalCriteria.length===0) { warning.style.display='block'; msg.textContent='No hay criterios globales seleccionados.'; return false; }
        const assigned = new Set();
        examState.questions.forEach(q => q.criteriaCodes.forEach(c=>assigned.add(c)));
        const missing = examState.globalCriteria.filter(c=>!assigned.has(c));
        if (missing.length>0) { warning.style.display='block'; msg.textContent = `Criterios no asignados: ${missing.map(c=>c+'.').join(', ')}`; return false; }
        warning.style.display='none'; return true;
    }
    function validateGenericCriteria() {
        const warning = document.getElementById('genericOrphanedCriteriaWarning');
        const msg = document.getElementById('genericOrphanedCriteriaMessage');
        if (genericState.globalCriteria.length===0) { warning.style.display='block'; msg.textContent='No hay criterios globales seleccionados.'; return false; }
        warning.style.display='none'; return true;
    }

    // =========================================================================
    //   FUNCIONES ESPEC√çFICAS DE EXAMEN POR PREGUNTAS
    // =========================================================================
    function renderExamQuestionsTable() {
        const tbody = document.getElementById('examQuestionsTbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        examState.questions.forEach((q, index) => {
            const tr = document.createElement('tr');
            // Crear badges con tooltip y data-code, a√±adiendo punto
            const badgesHtml = q.criteriaCodes.map(c => {
                const desc = getCriteriaDescription(c).replace(/"/g, '&quot;');
                return `<span class="badge badge-criteria me-1 criteria-badge" data-code="${c}" title="${desc}">${c}.</span>`;
            }).join('');
            tr.innerHTML = `
                <td><strong>P${q.id}</strong></td>
                <td style="width:140px;"><input type="number" class="form-control form-control-sm max-score-input" data-qidx="${index}" value="${q.maxScore}" min="0.1" max="10" step="0.1"></td>
                <td><span id="exam_criteriaBadges_${q.id}">${badgesHtml}</span></td>
                <td style="width:220px;">
                    <div class="d-flex flex-wrap gap-1">
                        <button class="btn btn-sm btn-outline-primary assign-criteria-btn" data-qid="${q.id}" data-bs-toggle="modal" data-bs-target="#examQuestionCriteriaModal"><i class="bi bi-tags"></i> Asignar</button>
                        <button class="btn btn-sm btn-outline-success insert-after-btn" data-index="${index}"><i class="bi bi-plus-circle"></i> + despu√©s</button>
                        <button class="btn btn-sm btn-outline-danger delete-question-btn" data-index="${index}"><i class="bi bi-trash3"></i></button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
        document.querySelectorAll('#examQuestionsTbody .max-score-input').forEach(inp => inp.addEventListener('change', function(){
            const idx = parseInt(this.dataset.qidx); if (examState.questions[idx]) examState.questions[idx].maxScore = parseFloat(this.value)||10;
        }));
        document.querySelectorAll('#examQuestionsTbody .assign-criteria-btn').forEach(btn => btn.addEventListener('click', function(){
            const qid = parseInt(this.dataset.qid); const question = examState.questions.find(q=>q.id===qid);
            document.getElementById('examModalQuestionId').textContent = qid;
            populateExamQuestionCriteria(question);
        }));
        document.querySelectorAll('#examQuestionsTbody .insert-after-btn').forEach(btn => btn.addEventListener('click', function(){
            const index = parseInt(this.dataset.index); const newId = examState.questions.length>0?Math.max(...examState.questions.map(q=>q.id))+1:1;
            examState.questions.splice(index+1, 0, {id:newId, maxScore:10, criteriaCodes:[]});
            examState.scores.forEach(row => row.splice(index+1,0,0));
            reorderExamQuestionIds(); normalizeExamScores(); renderExamQuestionsTable(); document.getElementById('examInputNumQuestions').value = examState.questions.length; validateExamCriteria();
        }));
        document.querySelectorAll('#examQuestionsTbody .delete-question-btn').forEach(btn => btn.addEventListener('click', function(){
            const index = parseInt(this.dataset.index); if (examState.questions.length<=1 && !confirm('¬øEliminar la √∫ltima pregunta?')) return;
            examState.questions.splice(index,1); examState.scores.forEach(row => row.splice(index,1));
            reorderExamQuestionIds(); normalizeExamScores(); renderExamQuestionsTable(); document.getElementById('examInputNumQuestions').value = examState.questions.length; validateExamCriteria();
        }));
    }
    function reorderExamQuestionIds() { examState.questions.forEach((q,i)=> q.id = i+1); }

    // =========================================================================
    //   FUNCI√ìN MODIFICADA: ahora solo muestra los criterios globales seleccionados
    // =========================================================================
    function populateExamQuestionCriteria(question) {
        const container = document.getElementById('examQuestionCriteriaGroupedContainer');
        if (!container) return;
        container.innerHTML = '';

        // Usar los criterios globales seleccionados, no todos los de la materia
        const availableCriteria = examState.globalCriteria;

        if (availableCriteria.length === 0) {
            container.innerHTML = '<div class="alert alert-warning">No hay criterios globales seleccionados. Ve a Configuraci√≥n y selecciona algunos primero.</div>';
            return;
        }

        const groups = groupCriteriaByCompetence(availableCriteria);
        const sortedGroups = Object.keys(groups).sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));

        sortedGroups.forEach((groupKey, index) => {
            const groupCodes = groups[groupKey];
            const groupDiv = document.createElement('div');
            groupDiv.className = 'criteria-group';
            groupDiv.style.borderLeftColor = competenceColors[index % competenceColors.length];
            groupDiv.innerHTML = `<div class="group-title"><i class="bi bi-diagram-3"></i> ${groupKey}</div><div class="row"></div>`;
            const rowDiv = groupDiv.querySelector('.row');

            groupCodes.forEach(code => {
                const col = document.createElement('div');
                col.className = 'col-md-6 mb-2';
                const isChecked = question.criteriaCodes.includes(code);
                const inputId = `exam_qchk_${question.id}_${code.replace(/\./g, '_')}`;
                const desc = getCriteriaDescription(code).replace(/"/g, '&quot;');
                col.innerHTML = `<div class="form-check">
                    <input class="form-check-input question-criteria-chk" type="checkbox" value="${code}" id="${inputId}" ${isChecked ? 'checked' : ''}>
                    <label class="form-check-label" for="${inputId}" title="${desc}">${code}.</label>
                </div>`;
                rowDiv.appendChild(col);
            });

            container.appendChild(groupDiv);
        });

        const saveBtn = document.getElementById('examSaveQuestionCriteria');
        saveBtn.onclick = function () {
            const selected = [];
            container.querySelectorAll('.question-criteria-chk:checked').forEach(chk => selected.push(chk.value));
            question.criteriaCodes = selected;
            renderExamQuestionsTable();
            validateExamCriteria();
        };
    }

    function renderExamGradeTable() {
        const thead = document.querySelector('#examGradeTable thead'); const tbody = document.getElementById('examGradeTbody');
        if (!thead||!tbody) return;
        if (examState.students.length===0 || examState.questions.length===0) { thead.innerHTML=''; tbody.innerHTML='<tr><td class="text-center p-4">Se requieren alumnos y preguntas.</td></tr>'; return; }
        normalizeExamScores();
        let headerHtml = '<tr><th>Alumno</th>'; examState.questions.forEach(q=> headerHtml+=`<th>P${q.id}<br><small>max ${q.maxScore}</small></th>`); headerHtml+='</tr>';
        thead.innerHTML = headerHtml;
        tbody.innerHTML = '';
        examState.students.forEach((student,sIdx)=>{
            const tr = document.createElement('tr'); tr.innerHTML = `<td><strong>${student.fullName}</strong></td>`;
            examState.questions.forEach((q,qIdx)=>{
                const td = document.createElement('td'); td.style.minWidth='80px';
                const val = examState.scores[sIdx]?.[qIdx]??0;
                td.innerHTML = `<input type="number" class="form-control form-control-sm exam-score-input" data-student="${sIdx}" data-question="${qIdx}" value="${val}" min="0" max="${q.maxScore}" step="0.1">`;
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
        document.querySelectorAll('.exam-score-input').forEach(inp=> inp.addEventListener('change', function(){
            const sIdx = parseInt(this.dataset.student); const qIdx = parseInt(this.dataset.question);
            let val = parseFloat(this.value); if (isNaN(val)) val=0; const max = examState.questions[qIdx].maxScore;
            if (val>max) val=max; if (val<0) val=0; this.value=val;
            if (!examState.scores[sIdx]) examState.scores[sIdx]=[]; examState.scores[sIdx][qIdx]=val;
        }));
    }
    // NUEVA VERSI√ìN: c√°lculo ponderado por los m√°ximos de las preguntas
    function renderExamResults() {
        const thead = document.querySelector('#examResultsTable thead'); const tbody = document.getElementById('examResultsTbody');
        if (!thead||!tbody) return;
        document.getElementById('examResultsExamNameSpan').textContent = `Examen: ${examState.examName}`;
        if (examState.globalCriteria.length===0 || examState.students.length===0) { 
            thead.innerHTML='<tr><th>Alumno</th><th>Sin criterios o alumnos</th></tr>'; 
            tbody.innerHTML='<tr><td colspan="2" class="text-center">Agregue criterios y alumnos.</td></tr>'; 
            return; 
        }
        normalizeExamScores();
        const showGlobal = document.getElementById('examShowGlobalGrade').checked;
        // Cabecera: Alumno + criterios (CON PUNTO) + (opcional) Calificaci√≥n
        let headerRow = '<tr><th>Alumno</th>';
        examState.globalCriteria.forEach(crit=> headerRow+=`<th>${crit}.</th>`); // A√ëADIDO PUNTO
        if (showGlobal) headerRow += '<th>Calificaci√≥n</th>';
        headerRow += '</tr>';
        thead.innerHTML = headerRow;
        tbody.innerHTML = '';
        
        examState.students.forEach((student,sIdx)=>{
            let rowHtml = `<td><strong>${student.fullName}</strong></td>`;
            let criteriasSum = 0;
            let criteriasCount = 0;
            examState.globalCriteria.forEach(crit=>{
                const qIndices = examState.questions.reduce((acc,q,qIdx)=> q.criteriaCodes.includes(crit)?[...acc,qIdx]:acc, []);
                if (qIndices.length===0) {
                    rowHtml += '<td class="text-muted">‚Äî</td>';
                } else {
                    // Suma de notas y suma de m√°ximos de las preguntas que eval√∫an el criterio
                    let sumaNotas = 0;
                    let sumaMaximos = 0;
                    qIndices.forEach(qIdx => {
                        sumaNotas += examState.scores[sIdx]?.[qIdx] || 0;
                        sumaMaximos += examState.questions[qIdx].maxScore;
                    });
                    // Nota del criterio = (sumaNotas / sumaMaximos) * 10
                    let notaCriterio = (sumaMaximos > 0) ? (sumaNotas / sumaMaximos) * 10 : 0;
                    // Redondear a 2 decimales
                    notaCriterio = Math.round(notaCriterio * 100) / 100;
                    rowHtml += `<td>${notaCriterio.toFixed(2)}</td>`;
                    criteriasSum += notaCriterio;
                    criteriasCount++;
                }
            });
            if (showGlobal) {
                let globalGrade = criteriasCount > 0 ? (criteriasSum / criteriasCount).toFixed(2) : '‚Äî';
                rowHtml += `<td><strong>${globalGrade}</strong></td>`;
            }
            tbody.innerHTML += `<tr>${rowHtml}</tr>`;
        });
    }
    // Funciones de exportaci√≥n para EXAMEN (con capitalizaci√≥n y t√≠tulo incrustado)
    // Tambi√©n adaptadas al nuevo c√°lculo ponderado. EL GRUPO SOLO APARECE EN EL NOMBRE DEL ARCHIVO.
    // Los c√≥digos de criterio en los encabezados y claves JSON llevan punto final.
    function exportExamJSON(includeGlobalGrade) {
        if (examState.students.length===0) return alert('No hay datos');
        const resultados = examState.students.map((student,sIdx)=>{
            const row = { Alumno: student.fullName };
            let criteriasSum = 0;
            let criteriasCount = 0;
            examState.globalCriteria.forEach(crit=>{
                const qIndices = examState.questions.reduce((acc,q,qIdx)=> q.criteriaCodes.includes(crit)?[...acc,qIdx]:acc, []);
                let notaCriterio = null;
                if (qIndices.length > 0) {
                    let sumaNotas = 0, sumaMaximos = 0;
                    qIndices.forEach(qIdx => {
                        sumaNotas += examState.scores[sIdx]?.[qIdx] || 0;
                        sumaMaximos += examState.questions[qIdx].maxScore;
                    });
                    notaCriterio = (sumaMaximos > 0) ? (sumaNotas / sumaMaximos) * 10 : 0;
                    notaCriterio = Math.round(notaCriterio * 100) / 100;
                }
                row[crit + '.'] = notaCriterio; // A√ëADIDO PUNTO
                if (notaCriterio !== null) { criteriasSum += notaCriterio; criteriasCount++; }
            });
            if (includeGlobalGrade) {
                row['Calificaci√≥n'] = criteriasCount > 0 ? parseFloat((criteriasSum / criteriasCount).toFixed(2)) : null;
            }
            return row;
        });
        const exportData = {
            examen: examState.examName,
            resultados: resultados
        };
        const blob = new Blob([JSON.stringify(exportData,null,2)],{type:'application/json'});
        const url = URL.createObjectURL(blob); const a = document.createElement('a');
        a.href = url;
        let base = sanitizeFilename(examState.examName + '_' + examState.course);
        base = capitalizeBasename(base);
        a.download = `Resultados_${base}.json`;
        a.click(); URL.revokeObjectURL(url);
    }
    function exportExamExcel(includeGlobalGrade) {
        if (examState.students.length===0) return alert('Sin datos');
        const header = ['Alumno', ...examState.globalCriteria.map(c=>c+'.')]; // A√ëADIDO PUNTO
        if (includeGlobalGrade) header.push('Calificaci√≥n');
        const wsData = [
            [`Examen: ${examState.examName}`],
            [],
            header
        ];
        examState.students.forEach((student,sIdx)=>{
            const row = [student.fullName];
            let criteriasSum = 0;
            let criteriasCount = 0;
            examState.globalCriteria.forEach(crit=>{
                const qIndices = examState.questions.reduce((acc,q,qIdx)=> q.criteriaCodes.includes(crit)?[...acc,qIdx]:acc, []);
                let notaCriterio = '';
                if (qIndices.length > 0) {
                    let sumaNotas = 0, sumaMaximos = 0;
                    qIndices.forEach(qIdx => {
                        sumaNotas += examState.scores[sIdx]?.[qIdx] || 0;
                        sumaMaximos += examState.questions[qIdx].maxScore;
                    });
                    notaCriterio = (sumaMaximos > 0) ? (sumaNotas / sumaMaximos) * 10 : 0;
                    notaCriterio = Math.round(notaCriterio * 100) / 100;
                }
                row.push(notaCriterio);
                if (notaCriterio !== '') { criteriasSum += notaCriterio; criteriasCount++; }
            });
            if (includeGlobalGrade) {
                let globalGrade = criteriasCount > 0 ? parseFloat((criteriasSum / criteriasCount).toFixed(2)) : '';
                row.push(globalGrade);
            }
            wsData.push(row);
        });
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsData), 'Resultados');
        let base = sanitizeFilename(examState.examName + '_' + examState.course);
        base = capitalizeBasename(base);
        XLSX.writeFile(wb, `Resultados_${base}.xlsx`);
    }
    function exportExamPDF(includeGlobalGrade) {
        if (examState.students.length===0) return alert('Sin datos');
        const { jsPDF } = window.jspdf; const doc = new jsPDF({ orientation: 'landscape' });
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text(examState.examName.toUpperCase(), 14, 20);
        doc.setFont(undefined, 'normal');
        doc.setFontSize(10);
        const headers = [['Alumno', ...examState.globalCriteria.map(c=>c+'.')]]; // A√ëADIDO PUNTO
        if (includeGlobalGrade) headers[0].push('Calificaci√≥n');
        const body = examState.students.map((student,sIdx)=>{
            const row = [student.fullName];
            let criteriasSum = 0;
            let criteriasCount = 0;
            examState.globalCriteria.forEach(crit=>{
                const qIndices = examState.questions.reduce((acc,q,qIdx)=> q.criteriaCodes.includes(crit)?[...acc,qIdx]:acc, []);
                let notaCriterio = '-';
                if (qIndices.length > 0) {
                    let sumaNotas = 0, sumaMaximos = 0;
                    qIndices.forEach(qIdx => {
                        sumaNotas += examState.scores[sIdx]?.[qIdx] || 0;
                        sumaMaximos += examState.questions[qIdx].maxScore;
                    });
                    let val = (sumaMaximos > 0) ? (sumaNotas / sumaMaximos) * 10 : 0;
                    notaCriterio = val.toFixed(2);
                    criteriasSum += val;
                    criteriasCount++;
                }
                row.push(notaCriterio);
            });
            if (includeGlobalGrade) {
                let globalGrade = criteriasCount > 0 ? (criteriasSum / criteriasCount).toFixed(2) : '-';
                row.push(globalGrade);
            }
            return row;
        });
        doc.autoTable({ head: headers, body, startY:30, theme:'grid' });
        let base = sanitizeFilename(examState.examName + '_' + examState.course);
        base = capitalizeBasename(base);
        doc.save(`Resultados_${base}.pdf`);
    }
    function exportExamConfig() {
        const cfg = { examName: examState.examName, course: examState.course, questions: examState.questions.map(q=>({...q, criteriaCodes:[...q.criteriaCodes]})), globalCriteria: [...examState.globalCriteria], students: examState.students.map(s=>({fullName:s.fullName})) };
        const blob = new Blob([JSON.stringify(cfg,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a');
        a.href = url;
        let base = sanitizeFilename(examState.examName);
        base = capitalizeBasename(base);
        a.download = `Configuraci√≥n_${base}.json`;
        a.click(); URL.revokeObjectURL(url);
    }
    function importExamConfig(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const cfg = JSON.parse(e.target.result);
                if (!cfg.examName || !Array.isArray(cfg.questions)) throw new Error('Formato inv√°lido');
                examState.examName = cfg.examName; examState.course = cfg.course || examState.course;
                examState.questions = cfg.questions.map(q=>({id:q.id, maxScore:q.maxScore, criteriaCodes:q.criteriaCodes||[]}));
                examState.globalCriteria = cfg.globalCriteria || [];
                examState.students = (cfg.students || []).map(s=>({id:uuid(), fullName:s.fullName}));
                examState.scores = examState.students.map(()=> new Array(examState.questions.length).fill(0));
                document.getElementById('examNameInput').value = examState.examName;
                document.getElementById('examCourseInput').value = examState.course;
                document.getElementById('examInputNumQuestions').value = examState.questions.length;
                sortStudents(examState,'scores'); renderExamGlobalBadges(); renderExamQuestionsTable(); renderExamStudentTags();
                // Actualizar el modal de criterios globales con la nueva selecci√≥n
                populateAllCriteriaModals();
                alert('‚úÖ Configuraci√≥n importada.');
            } catch(err) { alert('Error al importar: '+err.message); }
        };
        reader.readAsText(file);
    }
    // NUEVA VERSI√ìN: el callback de cambio ahora ordena, normaliza, refresca los tags y las tablas
    function renderExamStudentTags() {
        renderStudentTags(examState, 'examStudentTags', 'examStudentCountBadge', () => {
            sortStudents(examState, 'scores');
            normalizeExamScores();
            renderExamStudentTags(); // refrescar los tags despu√©s del cambio
            if (currentApp === 'exam' && document.getElementById('examScreenGrade').classList.contains('active')) {
                renderExamGradeTable();
            }
        });
    }

    // =========================================================================
    //   NUEVAS FUNCIONES PARA EXPORTAR/IMPORTAR/RECUPERAR CALIFICACIONES (EXAMEN)
    // =========================================================================
    function exportExamScores() {
        if (examState.students.length === 0 || examState.questions.length === 0) {
            alert('No hay datos de calificaciones para exportar.');
            return;
        }
        const data = {
            examName: examState.examName,
            course: examState.course,
            students: examState.students.map(s => s.fullName),
            questions: examState.questions.map(q => ({ id: q.id, maxScore: q.maxScore })),
            scores: examState.scores
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        let base = sanitizeFilename(examState.examName + '_' + examState.course);
        base = capitalizeBasename(base);
        a.download = `Calificaciones_${base}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function importExamScores(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                // Validaciones b√°sicas
                if (!data.examName || !Array.isArray(data.students) || !Array.isArray(data.questions) || !Array.isArray(data.scores)) {
                    throw new Error('El archivo no tiene el formato esperado.');
                }
                // Verificar que coincidan alumnos y preguntas actuales (por simplicidad, comparamos longitudes)
                if (data.students.length !== examState.students.length || data.questions.length !== examState.questions.length) {
                    if (!confirm('El n√∫mero de alumnos o preguntas no coincide. ¬øContinuar de todas formas? (puede causar errores)')) {
                        return;
                    }
                }
                // Opcional: podr√≠amos mapear por nombre, pero asumimos mismo orden
                examState.scores = data.scores;
                // Ajustar dimensiones si es necesario
                normalizeExamScores();
                renderExamGradeTable();
                document.getElementById('examGradeMessage').innerHTML = '<i class="bi bi-check-circle"></i> Calificaciones importadas correctamente.';
                setTimeout(() => document.getElementById('examGradeMessage').innerHTML = '', 3000);
            } catch (err) {
                alert('Error al importar: ' + err.message);
            }
        };
        reader.readAsText(file);
    }

    function recoverExamScores() {
        const saved = localStorage.getItem('exam_scores_backup');
        if (!saved) {
            alert('No hay calificaciones guardadas localmente.');
            return;
        }
        try {
            const data = JSON.parse(saved);
            // Similar a import, pero asumimos que es del mismo estado
            if (data.students && data.questions && data.scores) {
                // Podr√≠amos comparar con el estado actual, pero por simplicidad cargamos directamente
                examState.scores = data.scores;
                normalizeExamScores();
                renderExamGradeTable();
                document.getElementById('examGradeMessage').innerHTML = '<i class="bi bi-check-circle"></i> Calificaciones recuperadas.';
                setTimeout(() => document.getElementById('examGradeMessage').innerHTML = '', 3000);
            } else {
                alert('El formato guardado no es v√°lido.');
            }
        } catch (e) {
            alert('Error al recuperar: ' + e.message);
        }
    }

    // =========================================================================
    //   FUNCIONES ESPEC√çFICAS DE TIPO TEST (se mantienen igual)
    // =========================================================================
    function computeTestGrade(correct, wrong) {
        if (testState.totalQuestions <= 0) return 0;
        const valuePerCorrect = 10 / testState.totalQuestions;
        let grade = correct * valuePerCorrect - wrong * valuePerCorrect * testState.penaltyFactor;
        grade = Math.max(0, grade); 
        grade = Math.min(10, grade); // Aseguramos que no supere 10
        return Math.round(grade * 100) / 100;
    }
    function renderTestGradeTable() {
        const thead = document.querySelector('#testGradeTable thead'); const tbody = document.getElementById('testGradeTbody');
        if (!thead||!tbody) return;
        if (testState.students.length===0) { thead.innerHTML=''; tbody.innerHTML='<tr><td colspan="4" class="text-center p-4">A√±ade alumnos en Configuraci√≥n.</td></tr>'; return; }
        let headerHtml = '<tr><th>Alumno</th><th>Aciertos</th><th>Fallos</th><th>NS/NC</th>';
        testState.globalCriteria.forEach(crit => headerHtml += `<th>${crit}.</th>`); // A√ëADIDO PUNTO
        headerHtml += '</tr>';
        thead.innerHTML = headerHtml;
        tbody.innerHTML = '';
        testState.students.forEach((student, sIdx) => {
            if (!testState.studentScores[sIdx]) testState.studentScores[sIdx] = { studentId: student.id, correct: 0, wrong: 0, unanswered: testState.totalQuestions };
            const scores = testState.studentScores[sIdx];
            let sum = scores.correct + scores.wrong + scores.unanswered;
            if (sum !== testState.totalQuestions) scores.unanswered = Math.max(0, testState.totalQuestions - scores.correct - scores.wrong);
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><strong>${student.fullName}</strong></td>`;
            const tdCorrect = document.createElement('td');
            const selectCorrect = document.createElement('select'); selectCorrect.className = 'grade-select test-correct-select'; selectCorrect.dataset.student = sIdx;
            for (let i=0;i<=testState.totalQuestions;i++) { let opt = document.createElement('option'); opt.value=i; opt.textContent=i; if(i===scores.correct) opt.selected=true; selectCorrect.appendChild(opt); }
            tdCorrect.appendChild(selectCorrect); tr.appendChild(tdCorrect);
            const tdWrong = document.createElement('td');
            const selectWrong = document.createElement('select'); selectWrong.className = 'grade-select test-wrong-select'; selectWrong.dataset.student = sIdx;
            const maxWrong = testState.totalQuestions - scores.correct;
            for (let i=0;i<=maxWrong;i++) { let opt = document.createElement('option'); opt.value=i; opt.textContent=i; if(i===scores.wrong) opt.selected=true; selectWrong.appendChild(opt); }
            tdWrong.appendChild(selectWrong); tr.appendChild(tdWrong);
            const tdUnanswered = document.createElement('td');
            const spanUnanswered = document.createElement('span'); spanUnanswered.className = 'unanswered-field d-block'; spanUnanswered.id = `test_unanswered_${sIdx}`; spanUnanswered.textContent = scores.unanswered;
            tdUnanswered.appendChild(spanUnanswered); tr.appendChild(tdUnanswered);
            const grade = computeTestGrade(scores.correct, scores.wrong);
            testState.globalCriteria.forEach(() => { let td = document.createElement('td'); td.className='text-center fw-bold'; td.textContent=grade.toFixed(2); tr.appendChild(td); });
            tbody.appendChild(tr);
        });
        attachTestGradeEvents();
    }
    function attachTestGradeEvents() {
        document.querySelectorAll('.test-correct-select').forEach(select => {
            select.addEventListener('change', function() {
                const sIdx = parseInt(this.dataset.student); const newCorrect = parseInt(this.value);
                testState.studentScores[sIdx].correct = newCorrect;
                const wrongSelect = document.querySelector(`.test-wrong-select[data-student="${sIdx}"]`);
                const total = testState.totalQuestions; const maxWrong = total - newCorrect;
                const currentWrong = testState.studentScores[sIdx].wrong;
                wrongSelect.innerHTML = '';
                for (let i=0;i<=maxWrong;i++) { let opt = document.createElement('option'); opt.value=i; opt.textContent=i; if (i===currentWrong && currentWrong<=maxWrong) opt.selected=true; wrongSelect.appendChild(opt); }
                if (currentWrong > maxWrong) { wrongSelect.value = maxWrong; testState.studentScores[sIdx].wrong = maxWrong; }
                const wrong = parseInt(wrongSelect.value); const unanswered = total - newCorrect - wrong;
                testState.studentScores[sIdx].unanswered = unanswered;
                document.getElementById(`test_unanswered_${sIdx}`).textContent = unanswered;
                updateTestGradeRow(sIdx);
            });
        });
        document.querySelectorAll('.test-wrong-select').forEach(select => {
            select.addEventListener('change', function() {
                const sIdx = parseInt(this.dataset.student); const newWrong = parseInt(this.value);
                testState.studentScores[sIdx].wrong = newWrong;
                const correct = testState.studentScores[sIdx].correct; const total = testState.totalQuestions;
                const unanswered = total - correct - newWrong;
                testState.studentScores[sIdx].unanswered = unanswered;
                document.getElementById(`test_unanswered_${sIdx}`).textContent = unanswered;
                updateTestGradeRow(sIdx);
            });
        });
    }
    function updateTestGradeRow(sIdx) {
        const scores = testState.studentScores[sIdx]; const grade = computeTestGrade(scores.correct, scores.wrong);
        const row = document.querySelector(`#testGradeTbody tr:nth-child(${sIdx+1})`);
        if (row) { const cells = row.querySelectorAll('td'); for (let i=4; i<cells.length; i++) cells[i].textContent = grade.toFixed(2); }
    }
    function renderTestResults() {
        const thead = document.querySelector('#testResultsTable thead'); const tbody = document.getElementById('testResultsTbody');
        document.getElementById('testResultsExamNameSpan').innerHTML = `Test: "${testState.examName}"`;
        if (testState.globalCriteria.length===0 || testState.students.length===0) { 
            thead.innerHTML='<tr><th>Alumno</th><th>Sin criterios o alumnos</th></tr>'; 
            tbody.innerHTML='<tr><td colspan="2" class="text-center">Agregue criterios y alumnos.</td></tr>'; 
            return; 
        }
        const showGlobal = document.getElementById('testShowGlobalGrade').checked;
        let headerRow = '<tr><th>Alumno</th>';
        testState.globalCriteria.forEach(crit => headerRow+=`<th>${crit}.</th>`); // A√ëADIDO PUNTO
        if (showGlobal) headerRow += '<th>Calificaci√≥n</th>';
        headerRow += '</tr>';
        thead.innerHTML = headerRow;
        tbody.innerHTML = '';
        
        testState.students.forEach((student,sIdx)=>{
            const scores = testState.studentScores[sIdx]||{correct:0,wrong:0}; 
            const grade = computeTestGrade(scores.correct,scores.wrong);
            let rowHtml = `<td><strong>${student.fullName}</strong></td>`;
            testState.globalCriteria.forEach(()=> rowHtml += `<td class="text-center">${grade.toFixed(2)}</td>`);
            if (showGlobal) rowHtml += `<td class="text-center fw-bold">${grade.toFixed(2)}</td>`;
            tbody.innerHTML += `<tr>${rowHtml}</tr>`;
        });
    }
    // Funciones de exportaci√≥n para TEST (con t√≠tulo incrustado) incluyendo grupo SOLO EN NOMBRE
    function exportTestJSON(includeGlobalGrade) {
        if (testState.students.length===0) return alert('No hay datos');
        const resultados = []; testState.students.forEach((student,sIdx)=>{
            const scores = testState.studentScores[sIdx]||{correct:0,wrong:0,unanswered:0}; const grade = computeTestGrade(scores.correct,scores.wrong);
            const row = { Alumno: student.fullName, Aciertos: scores.correct, Fallos: scores.wrong, "NS/NC": scores.unanswered };
            testState.globalCriteria.forEach(crit => row[crit + '.'] = grade); // A√ëADIDO PUNTO
            if (includeGlobalGrade) row['Calificaci√≥n'] = grade;
            resultados.push(row);
        });
        const exportData = {
            examen: testState.examName,
            resultados: resultados
        };
        const blob = new Blob([JSON.stringify(exportData,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a');
        a.href = url;
        let base = sanitizeFilename(testState.examName + '_' + testState.course) || 'Resultados';
        base = capitalizeBasename(base);
        a.download = `${base}.json`;
        a.click(); URL.revokeObjectURL(url);
    }
    function exportTestExcel(includeGlobalGrade) {
        if (testState.students.length===0) return alert('Sin datos');
        const header = ['Alumno','Aciertos','Fallos','NS/NC', ...testState.globalCriteria.map(c=>c+'.')]; // A√ëADIDO PUNTO
        if (includeGlobalGrade) header.push('Calificaci√≥n');
        const wsData = [
            [`Examen: ${testState.examName}`],
            [],
            header
        ];
        testState.students.forEach((student,sIdx)=>{
            const scores = testState.studentScores[sIdx]||{correct:0,wrong:0,unanswered:0}; const grade = computeTestGrade(scores.correct,scores.wrong);
            const row = [student.fullName, scores.correct, scores.wrong, scores.unanswered, ...testState.globalCriteria.map(()=>grade)];
            if (includeGlobalGrade) row.push(grade);
            wsData.push(row);
        });
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsData), 'Resultados');
        let base = sanitizeFilename(testState.examName + '_' + testState.course) || 'Resultados';
        base = capitalizeBasename(base);
        XLSX.writeFile(wb, `${base}.xlsx`);
    }
    function exportTestPDF(includeGlobalGrade) {
        if (testState.students.length===0) return alert('Sin datos');
        const { jsPDF } = window.jspdf; const doc = new jsPDF({ orientation: 'landscape' });
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text(testState.examName.toUpperCase(), 14, 20);
        doc.setFont(undefined, 'normal');
        doc.setFontSize(10);
        const headers = [['Alumno', ...testState.globalCriteria.map(c=>c+'.')]]; // A√ëADIDO PUNTO
        if (includeGlobalGrade) headers[0].push('Calificaci√≥n');
        const body = testState.students.map((student,sIdx)=>{
            const scores = testState.studentScores[sIdx]||{correct:0,wrong:0}; const grade = computeTestGrade(scores.correct,scores.wrong);
            const row = [student.fullName, ...testState.globalCriteria.map(()=>grade.toFixed(2))];
            if (includeGlobalGrade) row.push(grade.toFixed(2));
            return row;
        });
        doc.autoTable({ head: headers, body, startY:30, theme:'grid' });
        let base = sanitizeFilename(testState.examName + '_' + testState.course) || 'Resultados';
        base = capitalizeBasename(base);
        doc.save(`${base}.pdf`);
    }
    function exportTestConfig() {
        const cfg = { examName: testState.examName, course: testState.course, totalQuestions: testState.totalQuestions, penaltyFactor: testState.penaltyFactor, globalCriteria: [...testState.globalCriteria], students: testState.students.map(s=>({fullName:s.fullName})), studentScores: testState.studentScores.map(ss=>({...ss})) };
        const blob = new Blob([JSON.stringify(cfg,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a');
        a.href = url;
        let base = sanitizeFilename(testState.examName)||'config';
        base = capitalizeBasename(base);
        a.download = `Configuracion_${base}.json`;
        a.click(); URL.revokeObjectURL(url);
    }
    function importTestConfig(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const cfg = JSON.parse(e.target.result);
                if (!cfg.totalQuestions || !Array.isArray(cfg.globalCriteria)) throw new Error('Formato inv√°lido');
                testState.examName = cfg.examName || 'Examen tipo test'; testState.course = cfg.course || 'Tecnolog√≠a Ciclos';
                testState.totalQuestions = cfg.totalQuestions; testState.penaltyFactor = cfg.penaltyFactor || 0;
                testState.globalCriteria = cfg.globalCriteria;
                testState.students = (cfg.students || []).map(s=>({id:uuid(), fullName:s.fullName}));
                testState.studentScores = cfg.studentScores || testState.students.map(()=>({correct:0,wrong:0,unanswered:testState.totalQuestions}));
                document.getElementById('testExamTitleInput').value = testState.examName;
                document.getElementById('testCourseInput').value = testState.course;
                document.getElementById('testTotalQuestions').value = testState.totalQuestions;
                document.querySelectorAll('input[name="penalty"]').forEach(r => { if (parseFloat(r.value) === testState.penaltyFactor) r.checked = true; });
                document.querySelectorAll('.penalty-option').forEach(o => o.classList.toggle('selected', o.querySelector('input')?.checked));
                sortStudents(testState,'studentScores'); renderTestGlobalBadges(); renderTestStudentTags();
                // Actualizar el modal de criterios globales con la nueva selecci√≥n
                populateAllCriteriaModals();
                alert('‚úÖ Configuraci√≥n importada.');
            } catch(err) { alert('Error al importar: '+err.message); }
        };
        reader.readAsText(file);
    }
    function renderTestStudentTags() {
        renderStudentTags(testState, 'testStudentTags', 'testStudentCountBadge', () => {
            sortStudents(testState, 'studentScores');
            // No hay normalize espec√≠fico para test, pero podemos recalcular unanswered si es necesario
            testState.studentScores = testState.studentScores.map(ss => ({
                ...ss,
                unanswered: testState.totalQuestions - (ss.correct || 0) - (ss.wrong || 0)
            }));
            renderTestStudentTags();
            if (currentApp === 'test' && document.getElementById('testScreenGrade').classList.contains('active')) {
                renderTestGradeTable();
            }
        });
    }

    // =========================================================================
    //   FUNCIONES ESPEC√çFICAS DE GEN√âRICA (con nuevo formato de exportaci√≥n)
    // =========================================================================
    function renderGenericGradeTable() {
        const thead = document.querySelector('#genericGradeTable thead'); const tbody = document.getElementById('genericGradeTbody');
        if (!thead||!tbody) return;
        if (genericState.students.length===0 || genericState.globalCriteria.length===0) { thead.innerHTML=''; tbody.innerHTML='<tr><td class="text-center p-4">Se requieren alumnos y criterios.</td></tr>'; return; }
        normalizeGenericScores();
        let headerHtml = '<tr><th>Alumno</th>'; genericState.globalCriteria.forEach((crit,idx)=> headerHtml+=`<th>${crit}.<br><small>(0-10)</small></th>`); headerHtml+='</tr>';
        thead.innerHTML = headerHtml;
        tbody.innerHTML = '';
        genericState.students.forEach((student,sIdx)=>{
            const tr = document.createElement('tr'); tr.innerHTML = `<td><strong>${student.fullName}</strong></td>`;
            genericState.globalCriteria.forEach((crit,cIdx)=>{
                const td = document.createElement('td'); td.style.minWidth='100px';
                const val = genericState.scores[sIdx]?.[cIdx]??0;
                td.innerHTML = `<input type="number" class="form-control form-control-sm generic-score-input" data-student="${sIdx}" data-criterion="${cIdx}" value="${val}" min="0" max="10" step="0.1">`;
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
        document.querySelectorAll('.generic-score-input').forEach(inp=> inp.addEventListener('change', function(){
            const sIdx = parseInt(this.dataset.student); const cIdx = parseInt(this.dataset.criterion);
            let val = parseFloat(this.value); if (isNaN(val)) val=0; val = Math.min(Math.max(val,0),10); this.value=val;
            if (!genericState.scores[sIdx]) genericState.scores[sIdx]=[]; genericState.scores[sIdx][cIdx]=val;
        }));
    }
    function renderGenericResults() {
        const thead = document.querySelector('#genericResultsTable thead'); const tbody = document.getElementById('genericResultsTbody');
        document.getElementById('genericResultsExamNameSpan').textContent = `Actividad: ${genericState.examName}`;
        if (genericState.globalCriteria.length===0 || genericState.students.length===0) { 
            thead.innerHTML='<tr><th>Alumno</th><th>Sin criterios o alumnos</th></tr>'; 
            tbody.innerHTML='<tr><td colspan="2" class="text-center">Agregue criterios y alumnos.</td></tr>'; 
            return; 
        }
        normalizeGenericScores();
        const showGlobal = document.getElementById('genericShowGlobalGrade').checked;
        let headerRow = '<tr><th>Alumno</th>';
        genericState.globalCriteria.forEach(crit=> headerRow+=`<th>${crit}.</th>`); // A√ëADIDO PUNTO
        if (showGlobal) headerRow += '<th>Calificaci√≥n</th>';
        headerRow += '</tr>';
        thead.innerHTML = headerRow;
        tbody.innerHTML = '';
        
        genericState.students.forEach((student,sIdx)=>{
            let rowHtml = `<td><strong>${student.fullName}</strong></td>`;
            let sum = 0;
            genericState.globalCriteria.forEach((crit,cIdx)=>{
                let val = genericState.scores[sIdx]?.[cIdx]??0;
                rowHtml += `<td>${val.toFixed(2)}</td>`;
                sum += val;
            });
            if (showGlobal) {
                let globalGrade = (sum / genericState.globalCriteria.length).toFixed(2);
                rowHtml += `<td><strong>${globalGrade}</strong></td>`;
            }
            tbody.innerHTML += `<tr>${rowHtml}</tr>`;
        });
    }

    // FUNCIONES DE EXPORTACI√ìN MODIFICADAS PARA GEN√âRICA (con guiones bajos)
    function exportGenericJSON(includeGlobalGrade) {
        if (genericState.students.length===0) return alert('No hay datos');
        const resultados = genericState.students.map((student,sIdx)=>{
            const row = { Alumno: student.fullName };
            genericState.globalCriteria.forEach((crit,cIdx)=> row[crit + '.'] = genericState.scores[sIdx]?.[cIdx]??0);
            if (includeGlobalGrade) {
                let sum = genericState.scores[sIdx].reduce((a,b)=>a+b,0);
                row['Calificaci√≥n'] = parseFloat((sum / genericState.globalCriteria.length).toFixed(2));
            }
            return row;
        });
        const exportData = {
            actividad: genericState.examName,
            resultados: resultados
        };
        const blob = new Blob([JSON.stringify(exportData,null,2)],{type:'application/json'});
        const url = URL.createObjectURL(blob); const a = document.createElement('a');
        a.href = url;
        // Formato con guiones bajos: Resultados_nombre_curso.json
        let base = sanitizeFilename(genericState.examName + '_' + genericState.course);
        a.download = `Resultados_${base}.json`;
        a.click(); URL.revokeObjectURL(url);
    }

    function exportGenericExcel(includeGlobalGrade) {
        if (genericState.students.length===0) return alert('Sin datos');
        const header = ['Alumno', ...genericState.globalCriteria.map(c=>c+'.')];
        if (includeGlobalGrade) header.push('Calificaci√≥n');
        const wsData = [
            [`Actividad: ${genericState.examName}`],
            [],
            header
        ];
        genericState.students.forEach((student,sIdx)=>{
            const row = [student.fullName];
            genericState.globalCriteria.forEach((crit,cIdx)=> row.push(genericState.scores[sIdx]?.[cIdx]??0));
            if (includeGlobalGrade) {
                let sum = genericState.scores[sIdx].reduce((a,b)=>a+b,0);
                let globalGrade = parseFloat((sum / genericState.globalCriteria.length).toFixed(2));
                row.push(globalGrade);
            }
            wsData.push(row);
        });
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsData), 'Resultados');
        let base = sanitizeFilename(genericState.examName + '_' + genericState.course);
        XLSX.writeFile(wb, `Resultados_${base}.xlsx`);
    }

    function exportGenericPDF(includeGlobalGrade) {
        if (genericState.students.length===0) return alert('Sin datos');
        const { jsPDF } = window.jspdf; const doc = new jsPDF({ orientation: 'landscape' });
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text(genericState.examName.toUpperCase(), 14, 20);
        doc.setFont(undefined, 'normal');
        doc.setFontSize(10);
        const headers = [['Alumno', ...genericState.globalCriteria.map(c=>c+'.')]];
        if (includeGlobalGrade) headers[0].push('Calificaci√≥n');
        const body = genericState.students.map((student,sIdx)=>{
            const row = [student.fullName];
            genericState.globalCriteria.forEach((crit,cIdx)=> row.push((genericState.scores[sIdx]?.[cIdx]??0).toFixed(2)));
            if (includeGlobalGrade) {
                let sum = genericState.scores[sIdx].reduce((a,b)=>a+b,0);
                let globalGrade = (sum / genericState.globalCriteria.length).toFixed(2);
                row.push(globalGrade);
            }
            return row;
        });
        doc.autoTable({ head: headers, body, startY:30, theme:'grid' });
        let base = sanitizeFilename(genericState.examName + '_' + genericState.course);
        doc.save(`Resultados_${base}.pdf`);
    }

    function exportGenericConfig() {
        const cfg = { examName: genericState.examName, course: genericState.course, globalCriteria: [...genericState.globalCriteria], students: genericState.students.map(s=>({fullName:s.fullName})) };
        const blob = new Blob([JSON.stringify(cfg,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a');
        a.href = url;
        let base = sanitizeFilename(genericState.examName);
        base = capitalizeBasename(base);
        a.download = `Configuraci√≥n_${base}.json`;
        a.click(); URL.revokeObjectURL(url);
    }
    function importGenericConfig(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const cfg = JSON.parse(e.target.result);
                if (!cfg.examName || !Array.isArray(cfg.globalCriteria)) throw new Error('Formato inv√°lido');
                genericState.examName = cfg.examName; genericState.course = cfg.course || genericState.course;
                genericState.globalCriteria = cfg.globalCriteria;
                genericState.students = (cfg.students || []).map(s=>({id:uuid(), fullName:s.fullName}));
                genericState.scores = genericState.students.map(()=> new Array(genericState.globalCriteria.length).fill(0));
                document.getElementById('genericExamNameInput').value = genericState.examName;
                document.getElementById('genericCourseInput').value = genericState.course;
                sortStudents(genericState,'scores'); renderGenericGlobalBadges(); renderGenericStudentTags();
                // Actualizar el modal de criterios globales con la nueva selecci√≥n
                populateAllCriteriaModals();
                alert('‚úÖ Configuraci√≥n importada.');
            } catch(err) { alert('Error al importar: '+err.message); }
        };
        reader.readAsText(file);
    }
    function renderGenericStudentTags() {
        renderStudentTags(genericState, 'genericStudentTags', 'genericStudentCountBadge', () => {
            sortStudents(genericState, 'scores');
            normalizeGenericScores();
            renderGenericStudentTags();
            if (currentApp === 'generic' && document.getElementById('genericScreenGrade').classList.contains('active')) {
                renderGenericGradeTable();
            }
        });
    }

    // =========================================================================
    //   FUNCIONES PARA REINICIAR (BORRAR TODOS LOS DATOS)
    // =========================================================================
    function resetExamState() {
        if (!confirm('¬øEst√°s seguro de que quieres reiniciar todos los datos de la aplicaci√≥n de examen? Se perder√°n los alumnos, criterios y calificaciones.')) return;
        examState.examName = "Examen sin t√≠tulo";
        examState.course = "Tecnolog√≠a Ciclos";
        examState.students = [];
        examState.questions = [{id:1, maxScore:10, criteriaCodes:[]}];
        examState.globalCriteria = [];
        examState.scores = [];
        document.getElementById('examNameInput').value = examState.examName;
        document.getElementById('examCourseInput').value = examState.course;
        document.getElementById('examInputNumQuestions').value = examState.questions.length;
        renderExamGlobalBadges();
        renderExamQuestionsTable();
        renderExamStudentTags();
        populateAllCriteriaModals();
        localStorage.removeItem('tec4_exam_app');
        alert('‚úÖ Todos los datos del examen han sido reiniciados.');
    }

    function resetTestState() {
        if (!confirm('¬øEst√°s seguro de que quieres reiniciar todos los datos de la aplicaci√≥n de tipo test? Se perder√°n los alumnos, criterios y calificaciones.')) return;
        testState.examName = "Examen tipo test";
        testState.course = "Tecnolog√≠a Ciclos";
        testState.totalQuestions = 20;
        testState.penaltyFactor = 0;
        testState.globalCriteria = [];
        testState.students = [];
        testState.studentScores = [];
        document.getElementById('testExamTitleInput').value = testState.examName;
        document.getElementById('testCourseInput').value = testState.course;
        document.getElementById('testTotalQuestions').value = testState.totalQuestions;
        // Resetear selecci√≥n de penalizaci√≥n
        document.querySelectorAll('#testPenaltyOptions .penalty-option input').forEach(r => {
            if (r.value == 0) r.checked = true;
        });
        document.querySelectorAll('.penalty-option').forEach(o => o.classList.toggle('selected', o.querySelector('input')?.checked));
        renderTestGlobalBadges();
        renderTestStudentTags();
        populateAllCriteriaModals();
        localStorage.removeItem('tec4_test_app');
        alert('‚úÖ Todos los datos del test han sido reiniciados.');
    }

    function resetGenericState() {
        if (!confirm('¬øEst√°s seguro de que quieres reiniciar todos los datos de la aplicaci√≥n gen√©rica? Se perder√°n los alumnos, criterios y calificaciones.')) return;
        genericState.examName = "Actividad sin t√≠tulo";
        genericState.course = "Tecnolog√≠a Ciclos";
        genericState.globalCriteria = [];
        genericState.students = [];
        genericState.scores = [];
        document.getElementById('genericExamNameInput').value = genericState.examName;
        document.getElementById('genericCourseInput').value = genericState.course;
        renderGenericGlobalBadges();
        renderGenericStudentTags();
        populateAllCriteriaModals();
        localStorage.removeItem('tec4_generic_app');
        alert('‚úÖ Todos los datos de la actividad gen√©rica han sido reiniciados.');
    }

    // =========================================================================
    //   CONTROL DE APLICACI√ìN ACTIVA Y NAVEGACI√ìN
    // =========================================================================
    let currentApp = 'home';
    function showHome() { hideAllApps(); document.getElementById('homeScreen').classList.add('active'); currentApp = 'home'; }
    function showApp(appId) {
        hideAllApps(); document.getElementById(appId).classList.add('active');
        if (appId === 'appExamContainer') { currentApp = 'exam'; showExamScreen('config'); }
        else if (appId === 'appTestContainer') { currentApp = 'test'; showTestScreen('config'); }
        else if (appId === 'appGenericContainer') { currentApp = 'generic'; showGenericScreen('config'); }
    }
    function hideAllApps() {
        document.getElementById('homeScreen').classList.remove('active');
        document.getElementById('appExamContainer').classList.remove('active');
        document.getElementById('appTestContainer').classList.remove('active');
        document.getElementById('appGenericContainer').classList.remove('active');
    }

    function showExamScreen(screen) {
        document.querySelectorAll('#appExamContainer .screen').forEach(s=>s.classList.remove('active'));
        document.getElementById('examScreen'+screen.charAt(0).toUpperCase()+screen.slice(1)).classList.add('active');
        document.querySelectorAll('#appExamContainer .btn-group .btn').forEach(b=>b.classList.remove('active'));
        document.getElementById('examNav'+screen.charAt(0).toUpperCase()+screen.slice(1)).classList.add('active');
        if (screen==='grade') renderExamGradeTable(); else if (screen==='results') renderExamResults();
    }
    function showTestScreen(screen) {
        document.querySelectorAll('#appTestContainer .screen').forEach(s=>s.classList.remove('active'));
        document.getElementById('testScreen'+screen.charAt(0).toUpperCase()+screen.slice(1)).classList.add('active');
        document.querySelectorAll('#appTestContainer .btn-group .btn').forEach(b=>b.classList.remove('active'));
        document.getElementById('testNav'+screen.charAt(0).toUpperCase()+screen.slice(1)).classList.add('active');
        if (screen==='grade') renderTestGradeTable(); else if (screen==='results') renderTestResults();
    }
    function showGenericScreen(screen) {
        document.querySelectorAll('#appGenericContainer .screen').forEach(s=>s.classList.remove('active'));
        document.getElementById('genericScreen'+screen.charAt(0).toUpperCase()+screen.slice(1)).classList.add('active');
        document.querySelectorAll('#appGenericContainer .btn-group .btn').forEach(b=>b.classList.remove('active'));
        document.getElementById('genericNav'+screen.charAt(0).toUpperCase()+screen.slice(1)).classList.add('active');
        if (screen==='grade') renderGenericGradeTable(); else if (screen==='results') renderGenericResults();
    }

    // =========================================================================
    //   EVENTO GLOBAL PARA MOSTRAR DESCRIPCI√ìN AL HACER CLIC EN CRITERIO (m√≥vil)
    // =========================================================================
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('criteria-badge')) {
            const code = e.target.getAttribute('data-code');
            if (code) {
                const desc = getCriteriaDescription(code);
                alert(`${code}: ${desc}`);
            }
            e.preventDefault();
            e.stopPropagation();
        }
    });

    // =========================================================================
    //   EVENTOS PRINCIPALES (CARGA INICIAL Y TODOS LOS BOTONES)
    // =========================================================================
    window.onload = function() {
        // Inicializar tooltips de Bootstrap
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Inicializar modales vac√≠os
        populateAllCriteriaModals();
        renderExamGlobalBadges();
        renderTestGlobalBadges();
        renderGenericGlobalBadges();
        renderExamQuestionsTable();
        renderExamStudentTags();
        renderTestStudentTags();
        renderGenericStudentTags();

        // Establecer valores iniciales de los inputs de curso
        document.getElementById('examCourseInput').value = examState.course;
        document.getElementById('testCourseInput').value = testState.course;
        document.getElementById('genericCourseInput').value = genericState.course;

        // Funci√≥n para comprobar si hay materia importada
        function checkSubjectImported() {
            if (subjectInfo.criteriaCodes.length === 0) {
                alert('ATENCI√ìN: debes importar un archivo de materia para poder usar las aplicaciones. Suelen tener el nombre `MATx.json¬¥, donde MAT son las iniciales de la materia y `x¬¥ es el curso');
                return false;
            }
            return true;
			
					// Registro del Service Worker para PWA
			if ('serviceWorker' in navigator) {
			  navigator.serviceWorker.register('sw.js')
				.then(reg => console.log('Service Worker registrado correctamente:', reg.scope))
				.catch(err => console.error('Error al registrar el Service Worker:', err));
			}	
			
        }

        // Evento importar materia
        document.getElementById('btnImportSubject').addEventListener('click', function() {
            document.getElementById('importSubjectFile').click();
        });
        document.getElementById('importSubjectFile').addEventListener('change', function(e) {
            if (this.files.length) {
                loadSubjectFromJSON(this.files[0]);
            }
            this.value = '';
        });

        // Navegaci√≥n entre aplicaciones con comprobaci√≥n de materia
        document.getElementById('btnHome').addEventListener('click', showHome);
        document.getElementById('btnAppExam').addEventListener('click', ()=> { if (checkSubjectImported()) showApp('appExamContainer'); });
        document.getElementById('btnAppTest').addEventListener('click', ()=> { if (checkSubjectImported()) showApp('appTestContainer'); });
        document.getElementById('btnAppGeneric').addEventListener('click', ()=> { if (checkSubjectImported()) showApp('appGenericContainer'); });
        document.getElementById('cardExam').addEventListener('click', ()=> { if (checkSubjectImported()) showApp('appExamContainer'); });
        document.getElementById('cardTest').addEventListener('click', ()=> { if (checkSubjectImported()) showApp('appTestContainer'); });
        document.getElementById('cardGeneric').addEventListener('click', ()=> { if (checkSubjectImported()) showApp('appGenericContainer'); });

        // ========== EXAMEN ==========
        document.getElementById('examSaveGlobalCriteria').addEventListener('click', function(){
            const checked = []; document.querySelectorAll('#examGlobalCriteriaGroupedContainer .global-criteria-chk:checked').forEach(chk=>checked.push(chk.value));
            examState.globalCriteria = checked; renderExamGlobalBadges();
        });
        document.getElementById('examNavConfig').addEventListener('click', ()=> showExamScreen('config'));
        document.getElementById('examNavGrade').addEventListener('click', function(){ 
            if (examState.students.length === 0) { alert('No hay alumnos. A√±ade alumnos en Configuraci√≥n.'); return; }
            if (validateExamCriteria()) showExamScreen('grade'); 
            else alert('Complete la asignaci√≥n de criterios.'); 
        });
        document.getElementById('examNavResults').addEventListener('click', function(){
            if (examState.students.length === 0) { alert('No hay alumnos. A√±ade alumnos en Configuraci√≥n.'); return; }
            if (!validateExamCriteria()) { alert('Los criterios no est√°n correctamente asignados.'); return; }
            showExamScreen('results');
        });
        document.getElementById('examBtnSetQuestions').addEventListener('click', function(){
            let num = parseInt(document.getElementById('examInputNumQuestions').value)||1;
            examState.questions = Array.from({length: num}, (_,i)=>({id:i+1, maxScore:10, criteriaCodes:[]}));
            normalizeExamScores(); renderExamQuestionsTable(); validateExamCriteria();
        });
        document.getElementById('examAppendQuestionBtn').addEventListener('click', function(){
            const newId = examState.questions.length>0?Math.max(...examState.questions.map(q=>q.id))+1:1;
            examState.questions.push({id:newId, maxScore:10, criteriaCodes:[]});
            examState.scores.forEach(row=>row.push(0)); reorderExamQuestionIds(); normalizeExamScores(); renderExamQuestionsTable(); document.getElementById('examInputNumQuestions').value = examState.questions.length; validateExamCriteria();
        });
        document.getElementById('examBtnAddStudent').addEventListener('click', function(){
            const input = document.getElementById('examStudentNameInput'); const name = input.value.trim();
            if (name) {
                if (isStudentDuplicate(examState,name)) { showDuplicateMessage('examDuplicateMessage',`El alumno "${name}" ya existe.`); input.value=''; return; }
                examState.students.push({id:uuid(), fullName:name}); normalizeExamScores(); sortStudents(examState,'scores'); renderExamStudentTags(); input.value=''; showDuplicateMessage('examDuplicateMessage','');
            }
        });
        document.getElementById('examBtnClearStudents').addEventListener('click', function(){ examState.students=[]; examState.scores=[]; renderExamStudentTags(); });
        document.getElementById('examImportFile').addEventListener('change', function(e) {
            if (this.files.length) importStudentsFromFile(this.files[0], examState, 'scores', ()=>{ renderExamStudentTags(); if (document.getElementById('examScreenGrade').classList.contains('active')) renderExamGradeTable(); });
            this.value = '';
        });
        document.getElementById('examExportConfigBtn').addEventListener('click', exportExamConfig);
        document.getElementById('examImportConfigBtn').addEventListener('click', ()=> document.getElementById('examImportConfigFile').click());
        document.getElementById('examImportConfigFile').addEventListener('change', function(e) {
            if (this.files.length) importExamConfig(this.files[0]);
            this.value = '';
        });
        document.getElementById('examSaveToLocalBtn').addEventListener('click', function(){ localStorage.setItem('tec4_exam_app',JSON.stringify(examState)); alert('‚úÖ Configuraci√≥n guardada.'); });
        document.getElementById('examLoadFromLocalBtn').addEventListener('click', function(){
            let saved = localStorage.getItem('tec4_exam_app');
            if(saved) {
                try {
                    Object.assign(examState, JSON.parse(saved));
                    examState.students = examState.students.map(s=>({...s, id:s.id||uuid()}));
                    normalizeExamScores(); renderExamGlobalBadges(); renderExamQuestionsTable(); renderExamStudentTags();
                    document.getElementById('examNameInput').value = examState.examName;
                    document.getElementById('examCourseInput').value = examState.course;
                    document.getElementById('examInputNumQuestions').value = examState.questions.length;
                    // Actualizar el modal de criterios globales con la nueva selecci√≥n
                    populateAllCriteriaModals();
                    alert('‚úÖ Configuraci√≥n cargada.');
                } catch(e) { alert('Error al cargar'); }
            } else alert('No hay datos guardados.');
        });
        // Guardar calificaciones (adem√°s guarda backup en localStorage)
        document.getElementById('examBtnSaveScores').addEventListener('click', function(){ 
            // Guardar en localStorage
            const backup = {
                students: examState.students.map(s => s.fullName),
                questions: examState.questions.map(q => ({ id: q.id, maxScore: q.maxScore })),
                scores: examState.scores
            };
            localStorage.setItem('exam_scores_backup', JSON.stringify(backup));
            document.getElementById('examGradeMessage').innerHTML='<i class="bi bi-check-circle"></i> Calificaciones guardadas localmente.';
            setTimeout(()=>document.getElementById('examGradeMessage').innerHTML='',3000); 
        });

        // Nuevos botones de calificaciones
        document.getElementById('examExportScoresBtn').addEventListener('click', exportExamScores);
        document.getElementById('examImportScoresBtn').addEventListener('click', () => document.getElementById('examImportScoresFile').click());
        document.getElementById('examImportScoresFile').addEventListener('change', function(e) {
            if (this.files.length) importExamScores(this.files[0]);
            this.value = '';
        });
        document.getElementById('examRecoverScoresBtn').addEventListener('click', recoverExamScores);

        // Bot√≥n Reiniciar todo en examen
        document.getElementById('examResetAllBtn').addEventListener('click', resetExamState);

        // Eventos para exportaci√≥n con modal
        let exportType = ''; // 'json', 'excel', 'pdf'
        document.getElementById('examExportJSON').addEventListener('click', function() {
            exportType = 'json';
            // Sincronizar checkbox del modal con el de la pantalla
            document.getElementById('examExportIncludeGrade').checked = document.getElementById('examShowGlobalGrade').checked;
        });
        document.getElementById('examExportExcel').addEventListener('click', function() {
            exportType = 'excel';
            document.getElementById('examExportIncludeGrade').checked = document.getElementById('examShowGlobalGrade').checked;
        });
        document.getElementById('examExportPDF').addEventListener('click', function() {
            exportType = 'pdf';
            document.getElementById('examExportIncludeGrade').checked = document.getElementById('examShowGlobalGrade').checked;
        });
        document.getElementById('examExportConfirm').addEventListener('click', function() {
            const include = document.getElementById('examExportIncludeGrade').checked;
            if (exportType === 'json') exportExamJSON(include);
            else if (exportType === 'excel') exportExamExcel(include);
            else if (exportType === 'pdf') exportExamPDF(include);
            // Cerrar modal
            bootstrap.Modal.getInstance(document.getElementById('examExportModal')).hide();
        });

        document.getElementById('examNameInput').addEventListener('input', e=> examState.examName = e.target.value);
        document.getElementById('examCourseInput').addEventListener('input', e=> examState.course = e.target.value);
        // Checkbox de resultados
        document.getElementById('examShowGlobalGrade').addEventListener('change', renderExamResults);

        // ========== TEST ==========
        document.getElementById('testSaveGlobalCriteria').addEventListener('click', function(){
            const checked = []; document.querySelectorAll('#testGlobalCriteriaGroupedContainer .global-criteria-chk:checked').forEach(chk=>checked.push(chk.value));
            testState.globalCriteria = checked; renderTestGlobalBadges();
        });
        document.getElementById('testNavConfig').addEventListener('click', ()=> showTestScreen('config'));
        document.getElementById('testNavGrade').addEventListener('click', function(){ 
            if (testState.students.length === 0) { alert('No hay alumnos. A√±ade alumnos en Configuraci√≥n.'); return; }
            if (testState.globalCriteria.length===0) alert('Selecciona al menos un criterio.'); 
            else showTestScreen('grade'); 
        });
        document.getElementById('testNavResults').addEventListener('click', function(){
            if (testState.students.length === 0) { alert('No hay alumnos. A√±ade alumnos en Configuraci√≥n.'); return; }
            if (testState.globalCriteria.length===0) { alert('Selecciona al menos un criterio.'); return; }
            showTestScreen('results');
        });
        document.getElementById('testExamTitleInput').addEventListener('input', e=> testState.examName = e.target.value);
        document.getElementById('testCourseInput').addEventListener('input', e=> testState.course = e.target.value);
        document.getElementById('testTotalQuestions').addEventListener('input', function(){
            let val = parseInt(this.value)||1; if (val<1) val=1; this.value=val; testState.totalQuestions=val;
            testState.studentScores = testState.students.map(()=>({correct:0,wrong:0,unanswered:val}));
            if (document.getElementById('testScreenGrade').classList.contains('active')) renderTestGradeTable();
        });
        document.querySelectorAll('#testPenaltyOptions .penalty-option').forEach(opt => {
            opt.addEventListener('click', function(){
                this.querySelector('input').checked=true;
                testState.penaltyFactor = parseFloat(this.querySelector('input').value);
                document.querySelectorAll('.penalty-option').forEach(o=>o.classList.remove('selected'));
                this.classList.add('selected');
            });
        });
        // Marcar la opci√≥n seleccionada inicialmente
        document.querySelectorAll('#testPenaltyOptions .penalty-option input:checked').forEach(inp => inp.closest('.penalty-option').classList.add('selected'));
        document.getElementById('testBtnAddStudent').addEventListener('click', function(){
            const input = document.getElementById('testStudentNameInput'); const name = input.value.trim();
            if (name) {
                if (isStudentDuplicate(testState,name)) { showDuplicateMessage('testDuplicateMessage',`El alumno "${name}" ya existe.`); input.value=''; return; }
                testState.students.push({id:uuid(), fullName:name}); testState.studentScores.push({correct:0,wrong:0,unanswered:testState.totalQuestions});
                sortStudents(testState,'studentScores'); renderTestStudentTags(); input.value=''; showDuplicateMessage('testDuplicateMessage','');
            }
        });
        document.getElementById('testBtnClearStudents').addEventListener('click', function(){ testState.students=[]; testState.studentScores=[]; renderTestStudentTags(); });
        document.getElementById('testImportFile').addEventListener('change', function(e) {
            if (this.files.length) importStudentsFromFile(this.files[0], testState, 'studentScores', ()=>{ renderTestStudentTags(); if (document.getElementById('testScreenGrade').classList.contains('active')) renderTestGradeTable(); });
            this.value = '';
        });
        document.getElementById('testExportConfigBtn').addEventListener('click', exportTestConfig);
        document.getElementById('testImportConfigBtn').addEventListener('click', ()=> document.getElementById('testImportConfigFile').click());
        document.getElementById('testImportConfigFile').addEventListener('change', function(e) {
            if (this.files.length) importTestConfig(this.files[0]);
            this.value = '';
        });
        document.getElementById('testSaveToLocalBtn').addEventListener('click', function(){ localStorage.setItem('tec4_test_app',JSON.stringify(testState)); alert('‚úÖ Configuraci√≥n guardada.'); });
        document.getElementById('testLoadFromLocalBtn').addEventListener('click', function(){
            let saved = localStorage.getItem('tec4_test_app');
            if(saved) {
                try {
                    Object.assign(testState, JSON.parse(saved));
                    testState.students = testState.students.map(s=>({...s, id:s.id||uuid()}));
                    if(!testState.studentScores) testState.studentScores = testState.students.map(()=>({correct:0,wrong:0,unanswered:testState.totalQuestions}));
                    sortStudents(testState,'studentScores');
                    renderTestGlobalBadges(); renderTestStudentTags();
                    document.getElementById('testExamTitleInput').value = testState.examName;
                    document.getElementById('testCourseInput').value = testState.course;
                    document.getElementById('testTotalQuestions').value = testState.totalQuestions;
                    document.querySelectorAll('input[name="penalty"]').forEach(r => { if (parseFloat(r.value) === testState.penaltyFactor) r.checked = true; });
                    document.querySelectorAll('.penalty-option').forEach(o => o.classList.toggle('selected', o.querySelector('input')?.checked));
                    // Actualizar el modal de criterios globales con la nueva selecci√≥n
                    populateAllCriteriaModals();
                    alert('‚úÖ Configuraci√≥n cargada.');
                } catch(e) { alert('Error al cargar'); }
            } else alert('No hay datos guardados.');
        });
        document.getElementById('testBtnSaveScores').addEventListener('click', function(){ document.getElementById('testGradeMessage').innerHTML='<i class="fas fa-check-circle"></i> Calificaciones guardadas.'; setTimeout(()=>document.getElementById('testGradeMessage').innerHTML='',3000); });

        // Bot√≥n Reiniciar todo en test
        document.getElementById('testResetAllBtn').addEventListener('click', resetTestState);

        // Exportaci√≥n test
        document.getElementById('testExportJSON').addEventListener('click', function() {
            exportType = 'json';
            document.getElementById('testExportIncludeGrade').checked = document.getElementById('testShowGlobalGrade').checked;
        });
        document.getElementById('testExportExcel').addEventListener('click', function() {
            exportType = 'excel';
            document.getElementById('testExportIncludeGrade').checked = document.getElementById('testShowGlobalGrade').checked;
        });
        document.getElementById('testExportPDF').addEventListener('click', function() {
            exportType = 'pdf';
            document.getElementById('testExportIncludeGrade').checked = document.getElementById('testShowGlobalGrade').checked;
        });
        document.getElementById('testExportConfirm').addEventListener('click', function() {
            const include = document.getElementById('testExportIncludeGrade').checked;
            if (exportType === 'json') exportTestJSON(include);
            else if (exportType === 'excel') exportTestExcel(include);
            else if (exportType === 'pdf') exportTestPDF(include);
            bootstrap.Modal.getInstance(document.getElementById('testExportModal')).hide();
        });
        document.getElementById('testShowGlobalGrade').addEventListener('change', renderTestResults);

        // ========== GEN√âRICA ==========
        document.getElementById('genericSaveGlobalCriteria').addEventListener('click', function(){
            const checked = []; document.querySelectorAll('#genericGlobalCriteriaGroupedContainer .global-criteria-chk:checked').forEach(chk=>checked.push(chk.value));
            genericState.globalCriteria = checked; renderGenericGlobalBadges(); normalizeGenericScores(); if (document.getElementById('genericScreenGrade').classList.contains('active')) renderGenericGradeTable();
        });
        document.getElementById('genericNavConfig').addEventListener('click', ()=> showGenericScreen('config'));
        document.getElementById('genericNavGrade').addEventListener('click', function(){ 
            if (genericState.students.length === 0) { alert('No hay alumnos. A√±ade alumnos en Configuraci√≥n.'); return; }
            if (validateGenericCriteria()) showGenericScreen('grade'); 
            else alert('Selecciona al menos un criterio.'); 
        });
        document.getElementById('genericNavResults').addEventListener('click', function(){
            if (genericState.students.length === 0) { alert('No hay alumnos. A√±ade alumnos en Configuraci√≥n.'); return; }
            if (!validateGenericCriteria()) { alert('Selecciona al menos un criterio.'); return; }
            showGenericScreen('results');
        });
        document.getElementById('genericExamNameInput').addEventListener('input', e=> genericState.examName = e.target.value);
        document.getElementById('genericCourseInput').addEventListener('input', e=> genericState.course = e.target.value);
        document.getElementById('genericBtnAddStudent').addEventListener('click', function(){
            const input = document.getElementById('genericStudentNameInput'); const name = input.value.trim();
            if (name) {
                if (isStudentDuplicate(genericState,name)) { showDuplicateMessage('genericDuplicateMessage',`El alumno "${name}" ya existe.`); input.value=''; return; }
                genericState.students.push({id:uuid(), fullName:name}); normalizeGenericScores(); sortStudents(genericState,'scores'); renderGenericStudentTags(); input.value=''; showDuplicateMessage('genericDuplicateMessage','');
            }
        });
        document.getElementById('genericBtnClearStudents').addEventListener('click', function(){ genericState.students=[]; genericState.scores=[]; renderGenericStudentTags(); });
        document.getElementById('genericImportFile').addEventListener('change', function(e) {
            if (this.files.length) importStudentsFromFile(this.files[0], genericState, 'scores', ()=>{ renderGenericStudentTags(); if (document.getElementById('genericScreenGrade').classList.contains('active')) renderGenericGradeTable(); });
            this.value = '';
        });
        document.getElementById('genericExportConfigBtn').addEventListener('click', exportGenericConfig);
        document.getElementById('genericImportConfigBtn').addEventListener('click', ()=> document.getElementById('genericImportConfigFile').click());
        document.getElementById('genericImportConfigFile').addEventListener('change', function(e) {
            if (this.files.length) importGenericConfig(this.files[0]);
            this.value = '';
        });
        document.getElementById('genericSaveToLocalBtn').addEventListener('click', function(){ localStorage.setItem('tec4_generic_app',JSON.stringify(genericState)); alert('‚úÖ Configuraci√≥n guardada.'); });
        document.getElementById('genericLoadFromLocalBtn').addEventListener('click', function(){
            let saved = localStorage.getItem('tec4_generic_app');
            if(saved) {
                try {
                    Object.assign(genericState, JSON.parse(saved));
                    genericState.students = genericState.students.map(s=>({...s, id:s.id||uuid()}));
                    normalizeGenericScores(); renderGenericGlobalBadges(); renderGenericStudentTags();
                    document.getElementById('genericExamNameInput').value = genericState.examName;
                    document.getElementById('genericCourseInput').value = genericState.course;
                    // Actualizar el modal de criterios globales con la nueva selecci√≥n
                    populateAllCriteriaModals();
                    alert('‚úÖ Configuraci√≥n cargada.');
                } catch(e) { alert('Error al cargar'); }
            } else alert('No hay datos guardados.');
        });
        document.getElementById('genericBtnSaveScores').addEventListener('click', function(){ document.getElementById('genericGradeMessage').innerHTML='<i class="bi bi-check-circle"></i> Calificaciones guardadas.'; setTimeout(()=>document.getElementById('genericGradeMessage').innerHTML='',3000); });

        // Bot√≥n Reiniciar todo en gen√©rica
        document.getElementById('genericResetAllBtn').addEventListener('click', resetGenericState);

        // Exportaci√≥n gen√©rica (con nuevo formato)
        document.getElementById('genericExportJSON').addEventListener('click', function() {
            window.exportType = 'json';
            document.getElementById('genericExportIncludeGrade').checked = document.getElementById('genericShowGlobalGrade').checked;
        });
        document.getElementById('genericExportExcel').addEventListener('click', function() {
            window.exportType = 'excel';
            document.getElementById('genericExportIncludeGrade').checked = document.getElementById('genericShowGlobalGrade').checked;
        });
        document.getElementById('genericExportPDF').addEventListener('click', function() {
            window.exportType = 'pdf';
            document.getElementById('genericExportIncludeGrade').checked = document.getElementById('genericShowGlobalGrade').checked;
        });
        document.getElementById('genericExportConfirm').addEventListener('click', function() {
            const include = document.getElementById('genericExportIncludeGrade').checked;
            if (window.exportType === 'json') exportGenericJSON(include);
            else if (window.exportType === 'excel') exportGenericExcel(include);
            else if (window.exportType === 'pdf') exportGenericPDF(include);
            bootstrap.Modal.getInstance(document.getElementById('genericExportModal')).hide();
        });
        document.getElementById('genericShowGlobalGrade').addEventListener('change', renderGenericResults);

        // Iniciar en Home
        showHome();

        // ========== INTRO: DESAPARECER A LOS 5 SEGUNDOS O AL HACER CLIC ==========
        const intro = document.getElementById('intro-overlay');
        if (intro) {
            // Funci√≥n para ocultar con fade-out
            const hideIntro = () => {
                if (!intro.classList.contains('fade-out')) {
                    intro.classList.add('fade-out');
                    // Opcional: eliminar del DOM despu√©s de la transici√≥n
                    setTimeout(() => {
                        if (intro.parentNode) intro.style.display = 'none';
                    }, 1000); // 1s coincide con transition
                }
            };
            // Temporizador 5s
            setTimeout(hideIntro, 5000);
            // Clic en cualquier parte de la ventana
            document.addEventListener('click', hideIntro, { once: true }); // con once para que solo ejecute una vez
        }
    };
</script>
</body>
</html>